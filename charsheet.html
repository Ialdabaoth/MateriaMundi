<main>
  <section class="header f-row">
    <label>Name:&nbsp;<input name="attr_character_name" type="text"></label><br>
    <label>Race:&nbsp;<input name="attr_race" list="race" type="text" class="w100"></label>
  </section>

  <section class="level f-row nowrap">
    <label>Class:&nbsp;<input name="attr_class" list="class" type="text" class="w120"></label>
    <label>Level:&nbsp;<input name="attr_level" class="level" ></label>
  </section>

  <section class="situation f-col nowrap">
    <div class="f-row nowrap">
      <label class="ability"><span name="attr_l3feat"></span></label>
<!--
      -<input class="round" type="checkbox">
      -<input class="round" type="checkbox">
      -<input class="round" type="checkbox">
      -<input class="round" type="checkbox"> 
-->
      <input name="attr_power" class="attack"><span style="font-size: 18px; font-style: bold;"><b>&nbsp;/&nbsp;</b></span><input name="attr_power_max" class="attack">

    </div>
    <div class="f-row nowrap">
      <label class="ability">Situation</label>
      <select class="dropdown" name="attr_d20">
        <option value="">Exploration</option>
        <option value="d20">Encounter</option>
        <option value="2d20kh1">(Advantage)</option>
        <option value="2d20kl1">(Disadvantage)</option>
      </select>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="ability">Initiative</label>
      <input name="attr_initiative" class="skill">
    </div>
    <div class="f-row nowrap">
      <label class="ability">Defense</label>
      <input name="attr_armor" type="text" class="w160">      
      <input name="attr_defense" class="defense">
    </div>
    <hr class="space">
    <hr class="space">
    <hr class="line">
    <div class="f-row nowrap">
      <label class="ability">Weapon Attacks</label>
      <input name="attr_attack" class="attack">
    </div>
    <div>
      <div class="f-row nowrap">
        <button class="attack" type="roll" name="roll_attack1" value="@{attack1_action}">
        </button>
        <input name="attr_weapon1" list="weapons" type="text" class="w220">
        <input name="attr_accuracy1" class="mod">
      </div>
      <div class="f-row nowrap">
        <button class="save" type="roll" name="roll_parry1" 
	  value="&{template:rolls} {{subtitle=Parry: @{weapon1}}} {{title=@{character_name} }} {{roll= [[@{defense}+@{parry1}+@{attack}[parry] ]]}}"></button>
        <input name="attr_parry1" class="mod">
        <label class="action">Parry</label>
        <label class="action">/</label>
        <label class="action">Damage</label>
        <input name="attr_damage1" class="w80">
        <button class="damage" type="roll" name="roll_damage1" 
  	  value="&{template:rolls} {{subtitle=Damage: @{weapon1}}} {{title=@{character_name} }} {{roll= [[@{damage1}[damage] ]]}}"></button>
      </div>
    </div>
    <hr class="space">
    <div>
      <div class="f-row nowrap">
        <button class="attack" type="roll" name="roll_attack2" value="@{attack2_action}">
        </button>
        <input name="attr_weapon2" list="weapons" type="text" class="w220">
        <input name="attr_accuracy2" class="mod">
      </div>
      <div class="f-row nowrap">
        <button class="save" type="roll" name="roll_parry2" 
	  value="&{template:rolls} {{subtitle=Parry: @{weapon2}}} {{title=@{character_name} }} {{roll= [[@{defense}+@{parry2}+@{attack}[parry] ]]}}"></button>
        <input name="attr_parry2" class="mod">
        <label class="action">Parry</label>
        <label class="action">/</label>
        <label class="action">Damage</label>
        <input name="attr_damage2" class="w80">
        <button class="damage" type="roll" name="roll_damage2" 
  	  value="&{template:rolls} {{subtitle=Damage: @{weapon2}}} {{title=@{character_name} }} {{roll= [[@{damage2}[damage] ]]}}"></button>
      </div>
    </div>

  </section>


  <section class="str f-col nowrap">
    <div class="f-row nowrap">
      <input name="attr_strength" class="ability">
      <label class="ability">Strength</label>
      <input name="attr_str" class="mod readonly">
    </div>
    <div class="f-row nowrap">
      <button class="save" type="roll" name="roll_athletics" 
	value="&{template:rolls} {{subtitle=Athletics}} {{title=@{character_name} }} {{roll= [[@{d20}@{str}+@{athletics}[athletics] ]]}}"></button>
      <label class="save">&nbsp;&nbsp;&nbsp;Athletics</label>
      <input name="attr_athletics_max" class="dv">
      <input name="attr_athletics" class="skill">
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="ability">Encumbrance</label>
      <input name="attr_encumbrance" class="attack">
    </div>
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Speed</label>
      <input name="attr_speed" class="skill">
    </div>
    <div class="f-row nowrap">
      <label class="save">&nbsp;&nbsp;&nbsp;<span name="attr_movemode"></span></label>
      <input name="attr_move" class="skill">
    </div>
  </section>

  <section class="dex f-col nowrap">
    <div class="f-row nowrap">
      <input name="attr_dexterity" class="ability">
      <label class="ability">Dexterity</label>
      <input name="attr_dex" class="mod readonly">
    </div>
    <div class="f-row nowrap">
      <button class="save" type="roll" name="roll_reflex" 
	value="&{template:rolls} {{subtitle=Reflex}} {{title=@{character_name} }} {{roll= [[@{d20}@{dex}+@{reflex}[reflex] ]]}}"></button>
      <label class="save">&nbsp;&nbsp;&nbsp;Reflex</label>
      <input name="attr_reflex_max" class="dv">
      <input name="attr_reflex" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="save" type="roll" name="roll_dodge" 
	value="&{template:rolls} {{subtitle=Dodge}} {{title=@{character_name} }} {{roll= [[@{defense}+@{reflex}[dodge] ]]}}"></button>
      <label class="action">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i>(Dodge)</i></label>
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_stealth" 
	value="&{template:rolls} {{subtitle=Stealth}} {{title=@{character_name} }} {{roll= [[@{d20}@{dex}+@{stealth}[stealth] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Stealth</label>
      <input name="attr_stealth" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_finesse" 
	value="&{template:rolls} {{subtitle=Finesse}} {{title=@{character_name} }} {{roll= [[@{d20}@{dex}+@{finesse}[finesse] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Finesse</label>
      <input name="attr_finesse" class="skill">
    </div>
  </section>

  <section class="con f-col nowrap">
    <div class="f-row nowrap">
      <input name="attr_constitution" class="ability">
      <label class="ability">Constitution</label>
      <input name="attr_con" class="mod readonly">
    </div>
    <div class="f-row nowrap">
      <button class="save" type="roll" name="roll_fortitude" 
	value="&{template:rolls} {{subtitle=Fortitude}} {{title=@{character_name} }} {{roll= [[@{d20}@{con}+@{fortitude}[fortitude] ]]}}"></button>
      <label class="save">&nbsp;&nbsp;&nbsp;Fortitude</label>
      <input name="attr_fortitude_max" class="dv">
      <input name="attr_fortitude" class="skill">
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="action nowrap">HP:<input name="attr_hitpoints" class="hp">/<input name="attr_hitpoints_max" class="hp"></label>      
      <label class="action nowrap">Wounds:<input name="attr_wounds" class="wounds">/<input name="attr_wounds_max" class="wounds"></label>      
    </div>
    <div class="f-row nowrap">
      <span>
        <input name="attr_conditions" class="conditions">
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="action">HD:</label>
      <span>
        <input name="attr_hd1_max" class="skill">
        <input name="attr_hd2_max" class="skill">
        <input name="attr_hd3_max" class="skill">
        <input name="attr_hd4_max" class="skill">
      </span>
    </div>
  </section>

  <section class="int f-col nowrap">
    <div class="f-row nowrap">
      <input name="attr_intelligence" class="ability">
      <label class="ability">Intelligence</label>
      <input name="attr_int" class="mod readonly">
    </div>
    <div class="f-row nowrap">
      <button class="save" type="roll" name="roll_deduction" 
	value="&{template:rolls} {{subtitle=Deduction}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{deduction}[deduction] ]]}}"></button>
      <label class="save">&nbsp;&nbsp;&nbsp;Deduction</label>
      <input name="attr_deduction_max" class="dv">
      <input name="attr_deduction" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_arcana" 
	value="&{template:rolls} {{subtitle=Arcana}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{arcana}[arcana] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Arcana</label>
      <input name="attr_arcana" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_craft" 
	value="&{template:rolls} {{subtitle=Crafting}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{craft}[craft] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Crafting</label>
      <input name="attr_craft" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_lore" 
	value="&{template:rolls} {{subtitle=Lore}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{lore}[lore] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Lore</label>
      <input name="attr_lore" class="skill">
    </div>
  </section>

  <section class="wis f-col nowrap">
    <div class="f-row nowrap">
      <input name="attr_wisdom" class="ability">
      <label class="ability">Wisdom</label>
      <input name="attr_wis" class="mod readonly">
    </div>
    <div class="f-row nowrap">
      <button class="save" type="roll" name="roll_perception" 
	value="&{template:rolls} {{subtitle=Perception}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{perception}[perception] ]]}}"></button>
      <label class="save">&nbsp;&nbsp;&nbsp;Perception</label>
      <input name="attr_perception_max" class="dv">
      <input name="attr_perception" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_animalken" 
	value="&{template:rolls} {{subtitle=Animal Ken}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{animalken}[animalken] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Animal Ken</label>
      <input name="attr_animalken" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_nature" 
	value="&{template:rolls} {{subtitle=Nature}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{nature}[nature] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Nature</label>
      <input name="attr_nature" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_medicine" 
	value="&{template:rolls} {{subtitle=Medicine}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{medicine}[medicine] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Medicine</label>
      <input name="attr_medicine" class="skill">
    </div>
  </section>

  <section class="cha f-col nowrap">
    <div class="f-row nowrap">
      <input name="attr_charisma" class="ability">
      <label class="ability">Charisma</label>
      <input name="attr_cha" class="mod readonly">
    </div>
    <div class="f-row nowrap">
      <button class="save" type="roll" name="roll_willpower" 
	value="&{template:rolls} {{subtitle=Willpower}} {{title=@{character_name} }} {{roll= [[@{d20}@{cha}+@{willpower}[willpower] ]]}}"></button>
      <label class="save">&nbsp;&nbsp;&nbsp;Willpower</label>
      <input name="attr_willpower_max" class="dv">
      <input name="attr_willpower" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_charm" 
	value="&{template:rolls} {{subtitle=Charm}} {{title=@{character_name} }} {{roll= [[@{d20}@{cha}+@{charm}[charm] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Charm</label>
      <input name="attr_charm" class="skill">
    </div>
    <div class="f-row nowrap">
      <button class="skill" type="roll" name="roll_wit" 
	value="&{template:rolls} {{subtitle=Wit}} {{title=@{character_name} }} {{roll= [[@{d20}@{cha}+@{wit}[wit] ]]}}"></button>
      <label class="skill">&nbsp;&nbsp;&nbsp;Wit</label>
      <input name="attr_wit" class="skill">
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="ability">Followers</label>
      <input name="attr_followers" class="w40">
    </div>

  </section>

  <section class="feats f-col">
    <h3>Class Features</h3>
    <div class="f-row nowrap">
      <label class="ability">&nbsp;1</label>
      <span><input name="attr_l1feat" class="w240"></span>
    </div>
    <div class="f-row nowrap">
      <label class="ability">&nbsp;2</label>
      <span><input name="attr_l2feat" class="w240"></span>
    </div>
    <div class="f-row nowrap">
      <label class="ability">&nbsp;3</label>
      <span><input name="attr_l3feat" class="w240"></span>
    </div>
    <div class="f-row nowrap">
      <label class="ability">&nbsp;4</label>
      <span><input name="attr_l4feat" class="w240"></span>
    </div>
    <div class="f-row nowrap">
      <label class="ability">&nbsp;5</label>
      <span><input name="attr_l5feat" class="w240"></span>
    </div>
    <div class="f-row nowrap">
      <label class="ability">&nbsp;6</label>
      <span><input name="attr_l6feat" class="w240"></span>
    </div>
    <div class="f-row nowrap">
      <label class="ability">&nbsp;7</label>
      <span><input name="attr_l7feat" class="w240"></span>
    </div>
    <div class="f-row nowrap">
      <label class="ability">&nbsp;8</label>
      <span><input name="attr_l8feat" class="w240"></span>
    </div>
    <div class="f-row nowrap">
      <label class="ability">&nbsp;9</label>
      <span><input name="attr_l9feat" class="w240"></span>
    </div>
    <div class="f-row nowrap">
      <label class="ability">10</label>
      <span><input name="attr_l10feat" class="w240"></span>
    </div>
  </section>

  <section class="inventory">
    <h3>Inventory</h3>
    <textarea name="attr_inventory"></textarea>
  </section>

  <footer class="f-col f-center">
    <span style="font-color: white;">(C) Bakagaijin Productions</span>
  </footer>
</main>

<!-- Datalists & thing that don't show directly on sheet -->

<datalist id="class">
    <option value="Warrior">Warrior</option>
    <option value="Expert">Expert</option>
    <option value="Magic-User">Magic-User</option>
</datalist>

<datalist id="race">
    <option value="Human">Human</option>
    <option value="Dwarf">Dwarf</option>
    <option value="Elf">Elf</option>
    <option value="Halfling">Halfling</option>
</datalist>

<!-- roll template -->

<rolltemplate class="sheet-rolltemplate-rolls">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
    </div>
    <div class="sheet-content">
      {{#allprops() title name subtitle desc}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title name subtitle desc}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-attacks">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
    </div>
    <div class="sheet-content">
      {{#hit}}
      <div class="sheet-key">Attack</div>
      <div class="sheet-value">{{hit}}</div>
      {{/hit}}
      {{#damage}}
      <div class="sheet-key">Damage</div>
      <div class="sheet-value">{{damage}}</div>
      {{/damage}}
      {{#allprops() title name subtitle desc attack hit damage}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title name subtitle desc attack hit damage}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>
</rolltemplate>

<!-- javascript -->

<script type="text/worker">
 const abilities = ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"];

 let races = [
        
          { "name": "Human", 
	    "type": "natural",
            "mods": [""],
            "size": "medium" },

          { "name": "Dwarf", 
	    "type": "natural",
            "mods": ["str", "con"],
            "size": "medium" },

          { "name": "Elf",
	    "type": "fey",
            "mods": ["dex", "wis"],
            "size": "medium" },

          { "name": "Halfling",
	    "type": "fey",
            "mods": ["dex", "cha"],
            "size": "small" },

          { "name": "Goblin",
	    "type": "natural",
            "mods": ["dex", "con"],
            "size": "small" },

          { "name": "Centaur",
	    "type": "natural",
            "mods": ["str", "wis"],
            "size": "medium" }
    ];

 //abilities.forEach(ability => { on("change:"+ability, function() { updatemod(ability); }); });

 on("sheet:opened change:character_name", function(eventInfo) {
	getAttrs(["character_name", "attack1_action", "attack2_action"], function(v) {
		var attrsToChange = {};
		attrsToChange["attack1_action"] = "%{" + v["character_name"] + "|attack1}";
		attrsToChange["attack2_action"] = "%{" + v["character_name"] + "|attack2}";
		setAttrs(attrsToChange);
	});
 });

 on("change:strength change:dexterity change:constitution change:intelligence change:wisdom change:charisma sheet:opened", 
  function() { abilities.forEach(ability => { updatemod(ability); }); });

 function updatemod(ability) {

  console.log("updating " + ability ); 
  getAttrs([ability,"race_max"], function(values) {
    let raceMods = values["race_max"];
//    let raceData = races.find(item => item.name == race);

    let av = values[ability];
    if(av == "") {
      av = rollAbility(ability);
      setAttrs({ [ability]: av });
    }
    let modname = ability.substring(0,3);
    let mod = a2mod(av);
    if(raceMods.includes(modname)) {
      mod++;
      if(mod >= 0) mod = "+" + mod; 
    }
    console.log("  " + ability + " (" + av + ") => " + modname + " (" + mod + ")");
    setAttrs({ [modname]: mod });
  });
 }

 function rollD6() {
   return Math.floor(Math.random()*6+1);
 }
 
 function rollAbility(ability) {
   return rollD6()+rollD6()+rollD6();
 }

 function a2mod(a) {
  if(a==3) return "-3";
  if(a<6) return "-2";
  if(a<9) return "-1";
  if(a==18) return "+3";
  if(a>15) return "+2";
  if(a>12) return "+1";
  return "+0";
 }

</script>
