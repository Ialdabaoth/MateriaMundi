<main>
  <section class="head">
    <div class="f-row">
      <label>Name:</label>
      <span><input name="attr_character_name" class="character-name"></span>
    </div>
    <div class="f-row nowrap">
      <label>Race:</label>
      <span><input name="attr_race" class="character-race"></span>
      <label>Bonuses:</label>
      <span><input name="attr_race_max" class="character-race"></span>
    </div>
  </section>

  <section class="builder">
  </section>
  
  <section class="level f-row nowrap">
    <span>
      <select name="attr_class" class="character-class">
        <option value="knight">Knight</option>
        <option value="martial artist">Martial Artist</option>
        <option value="berserker">Berserker</option>
        <option value="thief">Thief</option>
        <option value="alchemist">Alchemist</option>
        <option value="bard">Bard</option>
        <option value="wizard">Wizard</option>
        <option value="cleric">Cleric</option>
        <option value="druid">Druid</option>
      </select>
    </span>
    <span>
      <select name="attr_level" class="character-level">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
      </select>
    </span>
  </section>

  <section class="actions f-col nowrap">
   <input type="hidden" name="attr_level" class="character-level" >
   <div class="f-row nowrap">
      <label class="ability show-l3"><span name="attr_l3feat"></span></label>
      <input name="attr_power" class="bigbox show-l3"><span class="show-l3" style="font-size: 18px; font-style: bold;"><b>&nbsp;/&nbsp;</b></span><input name="attr_power_max" class="bigbox show-l3">
   </div>    
   <input type="hidden" name="attr_situation" class="situation-toggle">
   <div class="situationPanel">
   <div class="panelHeader">
    <button class="tab-travel" type="action" name="act_travel">Travel</button>
    <button class="tab-explore" type="action" name="act_explore">Explore</button>
    <button class="tab-fight" type="action" name="act_fight">Fight</button>
   </div>  
   <div class="panel-explore">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_skill">Interact</button>
      </span>
      <label class="description">Describe what action your character performs, then roll the skill that the referee asks for.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_watch">Watch</button>
      </span>
      <label class="description">Keeping Watch helps keep the party safe from ambushes.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_rest">Rest</button>
      </span>
      <label class="description">Resting spends one <b>hit die</b> to heal hit points and recover all <span name="attr_l3feat"></span>.<br>
      <input type="hidden" name="attr_level" class="character-level" >
      </label>
    </div> 
    <div class="f-row f-center">
      <span class="rollbox">
        <button class="proficiency" type="roll" name="roll_hd1" 
          value="&{template:rolls} {{subtitle=Hit Die (@{hd1}@{con})}} {{title=@{character_name} }} {{roll= [[{1d1,@{hd1}@{con}}kh1[hit points] ]]}}">
        </button><select name="attr_hd1" class="proficiency">
            <option value="">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
      &nbsp;
      <span class="rollbox show-l4">
        <button class="proficiency req-l4" type="roll" name="roll_hd2" 
          value="&{template:rolls} {{subtitle=Hit Die (@{hd2}@{con})}} {{title=@{character_name} }} {{roll= [[{1d1,@{hd2}@{con}}kh1[hit points] ]]}}">
        </button><select name="attr_hd2" class="proficiency req-l4">
            <option value="">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
      &nbsp;
      <span class="rollbox show-l7">
        <button class="proficiency req-l7" type="roll" name="roll_hd3" 
          value="&{template:rolls} {{subtitle=Hit Die (@{hd3}@{con})}} {{title=@{character_name} }} {{roll= [[{1d1,@{hd3}@{con}}kh1[hit points] ]]}}">
        </button><select name="attr_hd3" class="proficiency req-l7">
            <option value="">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
      &nbsp;
      <span class="rollbox show-l10">
        <button class="proficiency req-l10" type="roll" name="roll_hd4" 
          value="&{template:rolls} {{subtitle=Hit Die (@{hd4}@{con})}} {{title=@{character_name} }} {{roll= [[{1d1,@{hd4}@{con}}kh1[hit points] ]]}}">
        </button><select name="attr_hd4" class="proficiency req-l10">
            <option value="">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
    </div>
   </div panel-explore>
 
   <div class="panel-fight">
    <div class="f-row nowrap">
      <label class="proficiency">Initiative</label>
      <button class="proficiency" type="roll" name="roll_initiative" 
       value="&{template:rolls} {{subtitle=Initiative}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{perception}[perception] ]]}}">
      </button><input name="attr_initiative" class="proficiency">
    </div>
    <div class="f-row nowrap">
      <label class="proficiency">Defense</label>
      <input name="attr_armor" type="text" class="armor">      
      <input name="attr_defense" class="defense">
    </div>
    <div class="f-row nowrap">
      <label class="action">Last Action:</label>
      <label class="action"><span="attr_lastaction"></span></label>
    </div>
    <input type="hidden" name="attr_actiontab" class="action-toggle">
    <div class="actionPanel">
      <div class="panelHeader">
          <button class="tab-attack" type="action" name="act_attack">Attack</button>
          <button class="tab-defend" type="action" name="act_defend">Defend</button>
          <button class="tab-move" type="action" name="act_move">Move</button>
          <button class="tab-react" type="action" name="act_react">React</button>
      </div>    
      <div class="panel-attack">
        <hr class="space">
        <div class="f-row nowrap">
          <label class="proficiency">Weapon Attacks (<span name="attr_attack_max"></span>x)</label>
        <span class="rollbox">
            <button class="proficiency attack" type="roll" name="roll_attack" value="@{activeweapon}">
            </button><input name="attr_attack" class="proficiency">
        </span>
        </div>
        <hr class="line">
        <div>
          <div class="f-row nowrap">
            <input name="attr_activeweapon" type="radio" value="@{attack1_action}">
            <input name="attr_weapon1" class="weapon">
            <input name="attr_accuracy1" class="mod">
          </div>
          <hr class="space">
          <div class="f-row nowrap">
              <label class="action">&nbsp;&nbsp;Damage:</label><input name="attr_damage1" class="damage"><button class="damage" type="roll" name="roll_damage1" 
    	         value="&{template:rolls} {{subtitle=Damage: @{weapon1}}} {{title=@{character_name} }} {{roll= [[@{damage1}[damage] ]]}}">
              </button>
          </div>
        </div>
        <hr class="line">
        <div>
          <div class="f-row nowrap">
            <input name="attr_activeweapon" type="radio" value="@{attack2_action}">
            <input name="attr_weapon2" class="weapon">
            <input name="attr_accuracy2" class="mod">
          </div>
          <hr class="space">
          <div class="f-row nowrap">
              <label class="action">&nbsp;&nbsp;Damage:</label><input name="attr_damage2" class="damage"><button class="damage" type="roll" name="roll_damage2" 
  	           value="&{template:rolls} {{subtitle=Damage: @{weapon2}}} {{title=@{character_name} }} {{roll= [[@{damage2}[damage] ]]}}">
              </button>
          </div>
        </div>
      </div panel-attack>
      <div class="panel-move">
        <hr class="space">
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_walk">Walk</button>
            <label class="action"><span name="attr_speed"></span> paces / round</label>
        </div>
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_sprint">Sprint</button>
            <label class="action"><span name="attr_sprintspeed"></span> paces / round</label>
        </div>
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_jump">Jump</button>
            <label class="action"><span name="attr_jumpspeed"></span> paces</label>
        </div>
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_climb">Climb</button>
            <label class="action"><span name="attr_climbspeed"></span> paces / round</label>
        </div>
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_swim">Swim</button>
            <label class="action"><span name="attr_swimspeed"></span> paces / round</label>
        </div>
      </div panel-move>
      <div class="panel-defend">
        <hr class="space">
        <div class="f-row">
            <button type="action" class="action" name="act_guard">Guard</button>
            <label class="description">Regain your reaction after you successfully parry or hit with an opportunity attack</label>
        </div>
        <hr class="line">
        <div class="f-row">
            <button type="action" class="action" name="act_evade">Evade</button>
            <label class="description">Regain your reaction after you successfully dodge</label>
        </div>
        <hr class="line">
        <div class="f-row">
            <button type="action" class="action" name="act_hide">Hide</button>
            <label class="description">Roll Stealth to become hidden</label>
        </div>
      </div panel-defend>
      <div class="panel-react">
        <hr class="space">
        <div class="f-row">
          <span><button class="opportunity-attack" type="roll" name="roll_opattack" value="@{activeweapon}"></button></span>
          <label class="description"><b>Opportunity Attack</b>
          <br>Attack with your current weapon.</label>
        </div> 
        <hr class="line">
        <div class="f-row">
          <span><button class="defend" type="roll" name="roll_dodge" 
   	        value="&{template:rolls} {{subtitle=Dodge}} {{title=@{character_name} }} {{roll= [[@{defense}+@{reflex}[dodge] ]]}}"></button></span>
          <label class="description"><b>Dodge</b><br>
          Add <b><span name="attr_reflex"></span></b> to your Defense vs one attack.</label>
        </div> 
        <hr class="line">
        <div class="f-row">
          <span><button class="defend" type="roll" name="roll_parry" 
   	        value="&{template:rolls} {{subtitle=Parry (@{weapon2})}} {{title=@{character_name} }} {{roll= [[@{defense}+@{parry2}+@{attack}[parry] ]]}}"></button></span>
          <label class="description"><b>Parry (<span name="attr_weapon2"></span>)</b><br>
          Add <b><span name="attr_attack"></span><span name="attr_parry2"></span></b>
          to your Defense vs one melee attack (or vs one ranged attack if you are using a shield).</label>
        </div> 
      </div panel-react>
    </div actionPanel>
   </div panel-fight>
  </div situationPanel>
  </section>


  <section class="str f-col nowrap">
    <div class="f-row nowrap">
      <!--input name="attr_strength" class="ability" type="number"-->
      <select name="attr_strength" class="ability">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <label class="ability">Strength</label>
      <input name="attr_str" class="mod-lg" readonly>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save">&nbsp;&nbsp;&nbsp;Athletics</label>
      <input name="attr_athletics_max" class="dv" readonly>
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_athletics" 
	      value="&{template:rolls} {{subtitle=Athletics}} {{title=@{character_name} }} {{roll= [[@{d20}@{str}+@{athletics}[athletics] ]]}}">
        </button><select name="attr_athletics" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select><!--input name="attr_athletics" class="proficiency"-->
      </span>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="ability">Encumbrance</label>
      <input name="attr_encumbrance" class="bigbox">
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;<span name="attr_movement"></span> Speed</label>
      <input name="attr_move" class="bigbox">
    </div>
  </section>

  <section class="dex f-col nowrap">
    <div class="f-row nowrap">
      <select name="attr_dexterity" class="ability">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <label class="ability">Dexterity</label>
      <input name="attr_dex" class="mod-lg" readonly>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save">&nbsp;&nbsp;&nbsp;Reflex</label>
      <input name="attr_reflex_max" class="dv" readonly>
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_reflex" 
	      value="&{template:rolls} {{subtitle=Reflex}} {{title=@{character_name} }} {{roll= [[@{d20}@{dex}+@{reflex}[reflex] ]]}}">
        </button><select name="attr_reflex" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Stealth</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_stealth" 
	      value="&{template:rolls} {{subtitle=Stealth}} {{title=@{character_name} }} {{roll= [[@{d20}@{dex}+@{stealth}[stealth] ]]}}">
        </button><select name="attr_stealth" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Finesse</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_finesse" 
      	  value="&{template:rolls} {{subtitle=Finesse}} {{title=@{character_name} }} {{roll= [[@{d20}@{dex}+@{finesse}[finesse] ]]}}">
        </button><select name="attr_finesse" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
    </div>
  </section>

  <section class="con f-col nowrap">
    <div class="f-row nowrap">
      <select name="attr_constitution" class="ability">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <label class="ability">Constitution</label>
      <input name="attr_con" class="mod-lg" readonly>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save">&nbsp;&nbsp;&nbsp;Fortitude</label>
      <input name="attr_fortitude_max" class="dv" readonly>
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_fortitude" 
	      value="&{template:rolls} {{subtitle=Fortitude}} {{title=@{character_name} }} {{roll= [[@{d20}@{con}+@{fortitude}[fortitude] ]]}}">
        </button><select name="attr_fortitude" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>    
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="action nowrap">Hit Points:</label>
      <label class="action nowrap f-right"><input name="attr_temp-hitpoints" class="hp alt">+<input name="attr_hitpoints" class="hp">/<input name="attr_hitpoints_max" class="hp"></label>      
    </div>
    <div class="f-row nowrap">
      <label class="action nowrap">Fatigue+Wounds:</label>
      <label class="action nowrap f-right"><input name="attr_fatigue" class="wounds alt">+<input name="attr_wounds" class="wounds"></label>      
    </div>
  </section>

  <section class="int f-col nowrap">
    <div class="f-row nowrap">
      <select name="attr_intelligence" class="ability">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <label class="ability">Intelligence</label>
      <input name="attr_int" class="mod-lg" readonly>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save">&nbsp;&nbsp;&nbsp;Deduction</label>
      <input name="attr_deduction_max" class="dv" readonly>
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_deduction" 
	      value="&{template:rolls} {{subtitle=Deduction}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{deduction}[deduction] ]]}}">
        </button><select name="attr_deduction" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Arcana</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_arcana" 
	      value="&{template:rolls} {{subtitle=Arcana}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{arcana}[arcana] ]]}}">
        </button><select name="attr_arcana" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Crafting</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_craft" 
	      value="&{template:rolls} {{subtitle=Crafting}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{craft}[craft] ]]}}">
        </button><select name="attr_craft" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Lore</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_lore" 
	      value="&{template:rolls} {{subtitle=Lore}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{lore}[lore] ]]}}">
        </button><select name="attr_lore" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>
    </div>
  </section>

  <section class="wis f-col nowrap">
    <div class="f-row nowrap">
      <select name="attr_wisdom" class="ability">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <label class="ability">Wisdom</label>
      <input name="attr_wis" class="mod-lg" readonly>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save">&nbsp;&nbsp;&nbsp;Perception</label>
      <input name="attr_perception_max" class="dv" readonly>
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_perception" 
	      value="&{template:rolls} {{subtitle=Perception}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{perception}[perception] ]]}}">
        </button><select name="attr_perception" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Animal Ken</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_animalken" 
	      value="&{template:rolls} {{subtitle=Animal Ken}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{animalken}[animalken] ]]}}">
        </button><select name="attr_animalken" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Nature</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_nature" 
	      value="&{template:rolls} {{subtitle=Nature}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{nature}[nature] ]]}}">
        </button><select name="attr_nature" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>    
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Medicine</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_medicine" 
	      value="&{template:rolls} {{subtitle=Medicine}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{medicine}[medicine] ]]}}">
        </button><select name="attr_medicine" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>    
    </div>
  </section>

  <section class="cha f-col nowrap">
    <div class="f-row nowrap">
      <select name="attr_charisma" class="ability">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <label class="ability">Charisma</label>
      <input name="attr_cha" class="mod-lg" readonly>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save">&nbsp;&nbsp;&nbsp;Willpower</label>
      <input name="attr_willpower_max" class="dv" readonly>
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_willpower" 
	      value="&{template:rolls} {{subtitle=Willpower}} {{title=@{character_name} }} {{roll= [[@{d20}@{cha}+@{willpower}[willpower] ]]}}">
        </button><select name="attr_willpower" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>    
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Charm</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_charm" 
	      value="&{template:rolls} {{subtitle=Charm}} {{title=@{character_name} }} {{roll= [[@{d20}@{cha}+@{charm}[charm] ]]}}">
        </button><select name="attr_charm" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>    
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill">&nbsp;&nbsp;&nbsp;Wit</label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_wit" 
	      value="&{template:rolls} {{subtitle=Wit}} {{title=@{character_name} }} {{roll= [[@{d20}@{cha}+@{wit}[wit] ]]}}">
        </button><select name="attr_wit" class="proficiency">
            <option value="2d4kl1">-</option>
            <option value="d4">d4</option>
            <option value="d6">d6</option>
            <option value="d8">d8</option>
            <option value="d10">d10</option>
            <option value="d12">d12</option>
        </select>
      </span>    
    </div>

  </section>

  <section class="feats f-col">
    <h3>Class Features</h3>
    <input type="hidden" name="attr_level" class="character-level" >
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;1</label>
      <span class="flush"><input name="attr_l1feat" class="list-first"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;2</label>
      <span class="flush"><input name="attr_l2feat" class="list-middle req-l2"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;3</label>
      <span class="flush"><input name="attr_l3feat" class="list-middle req-l3"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;4</label>
      <span class="flush"><input name="attr_l4feat" class="list-middle req-l4"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;5</label>
      <span class="flush"><input name="attr_l5feat" class="list-middle req-l5"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;6</label>
      <span class="flush"><input name="attr_l6feat" class="list-middle req-l6"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;7</label>
      <span class="flush"><input name="attr_l7feat" class="list-middle req-l7"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;8</label>
      <span class="flush"><input name="attr_l8feat" class="list-middle req-l8"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;9</label>
      <span class="flush"><input name="attr_l9feat" class="list-middle req-l9"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">10</label>
      <span class="flush"><input name="attr_l10feat" class="list-last req-l10"></span>
    </div>
  </section>

  <section class="equipment">
    <h3>Equipment</h3>
    <div class="f-row nowrap flush">
      <label class="action flush">Armor</label>
      <span class="flush"><input name="attr_eqarmor" class="list-first"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush">R Hand</label>
      <span class="flush"><input name="attr_eqhand1" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush">L Hand</label>
      <span class="flush"><input name="attr_eqhand2" class="list-last"></span>
    </div>
    <hr class="line">
    <div class="f-row nowrap flush">
      <label class="action flush">Crown</label>
      <span class="flush"><input name="attr_eqcrown" class="list-first"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush">Amulet</label>
      <span class="flush"><input name="attr_eqamulet" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush">Ring <span style="font-size: 67%;">(R)</span></label>
      <span class="flush"><input name="attr_eqring1" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush">Ring <span style="font-size: 67%;">(L)</span></label>
      <span class="flush"><input name="attr_eqring2" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush">Belt</label>
      <span class="flush"><input name="attr_eqbelt" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush">Boots</label>
      <span class="flush"><input name="attr_eqboots" class="list-last"></span>
    </div>
  </section>

  <section class="inventory">
    <h3>Inventory</h3>
    <textarea name="attr_inventory" class="inventory"></textarea>
  </section>

  <footer class="f-col f-center">
    <span style="font-color: white;">(C) Bakagaijin Productions</span>
  </footer>
</main>

<!-- roll template -->

<rolltemplate class="sheet-rolltemplate-rolls">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
    </div>
    <div class="sheet-content">
      {{#allprops() title name subtitle desc}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title name subtitle desc}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-attacks">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
    </div>
    <div class="sheet-content">
      {{#hit}}
      <div class="sheet-key">Attack</div>
      <div class="sheet-value">{{hit}}</div>
      {{/hit}}
      {{#damage}}
      <div class="sheet-key">Damage</div>
      <div class="sheet-value">{{damage}}</div>
      {{/damage}}
      {{#allprops() title name subtitle desc attack hit damage}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title name subtitle desc attack hit damage}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>
</rolltemplate>

<!-- javascript -->
<script type="text/worker">

/*===== tabbed functionality =====*/
    const situationTabs = ["travel", "explore", "fight"];
    situationTabs.forEach(tab => {
        on(`clicked:${tab}`, function() {
            console.log("  clicked " + tab);
            setAttrs({ situation: tab });
        });
    });

    const actionTabs = ["attack", "move", "defend", "react"];
    actionTabs.forEach(tab => {
        on(`clicked:${tab}`, function() {
            console.log("  clicked " + tab);
            setAttrs({ actiontab: tab });
        });
    });

    const moveTabs = ["walk", "sprint", "climb", "swim", "jump"];
    moveTabs.forEach(tab => {
        on(`clicked:${tab}`, function() {
            let val = String(tab).charAt(0).toUpperCase() + String(tab).slice(1);
            let t = tab; if(tab == "walk") t = "";
    		var attrsToChange = {};
            getAttrs([t+"speed", "move"], function(v) {
                console.log("  clicked " + tab + "; retrieving " + t+"speed (" + v[t+"speed"] + ")");
                attrsToChange["move"] = v[t+"speed"];
                attrsToChange["movement"] = val;
        		setAttrs(attrsToChange);
            });
        });
    });


/*===== auto-computing fields =====*/
    const abilities = ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"];
    abilities.forEach(ability => { on(`change:${ability}`, function() { updatemod(ability); }); });
 
    const saves = ["athletics", "reflex", "fortitude", "deduction", "perception","willpower"];
    saves.forEach(save => { on(`change:${save}`, function() { updatedv(save); }); });

    on("sheet:opened", function() {
      abilities.forEach(ability => { updatemod(ability); });
      saves.forEach(save => { updatedv(save); });
      setupActions();
    });
 
    on("change:character_name", function(eventInfo) { setupActions(); });

    function updatedv(save) {
      let dv = save+"_max"; 
      let mod = save2mod(save);
      console.log("updating " + save + "("+mod+")");
      getAttrs([save, mod], function(values) {
        let prof = values[save];
        let val = 10+1*values[mod];
        if(prof[0] == 'd') val += prof.substring(1,2)/2;
        console.log("  " + save + " (" + prof + "+"+ values[mod] + ") => " + dv + " (" + val + ")");
    	setAttrs({ [dv] : val} );      
      });
    }

 
 function updatemod(ability) {
  console.log("updating " + ability ); 
  getAttrs([ability,"race_max"], function(values) {
    let raceMods = values["race_max"];
    let av = values[ability];
    if(av == "") {
      av = rollAbility(ability);
      setAttrs({ [ability]: av });
    }
    let modname = ability.substring(0,3);
    let mod = a2mod(av);
    if(String(raceMods).toLowerCase().includes(String(modname).toLowerCase())) {
      mod++;
      if(mod >= 0) mod = "+" + mod; 
    }
    console.log("  " + ability + " (" + av + ") => " + modname + " (" + mod + ")");
    setAttrs({ [modname]: mod });
    updatedv(mod2save(modname));
  });
 }

 function setupActions() {
    getAttrs(["character_name", "attack1_action", "attack2_action"], function(v) {
		var attrsToChange = {};
		attrsToChange["attack1_action"] = "%{" + v["character_name"] + "|attack1}";
		attrsToChange["attack2_action"] = "%{" + v["character_name"] + "|attack2}";
		setAttrs(attrsToChange);
	});
 }


 function rollD6() {
   return Math.floor(Math.random()*6+1);
 }
 
 function rollAbility(ability) {
   return rollD6()+rollD6()+rollD6();
 }

 function a2mod(a) {
  if(a==3) return "-3";
  if(a<6) return "-2";
  if(a<9) return "-1";
  if(a==18) return "+3";
  if(a>15) return "+2";
  if(a>12) return "+1";
  return "+0";
 }
 function save2mod(save) {
    if(save == "athletics") return "str";
    if(save == "reflex") return "dex";
    if(save == "fortitude") return "con";
    if(save == "deduction") return "int";
    if(save == "perception") return "wis";
    if(save == "willpower") return "cha";
 }
 function mod2save(mod) {
    if(mod == "str") return "athletics";
    if(mod == "dex") return "reflex";
    if(mod == "con") return "fortitude";
    if(mod == "int") return "deduction";
    if(mod == "wis") return "perception";
    if(mod == "cha") return "willpower";
 }
</script>
