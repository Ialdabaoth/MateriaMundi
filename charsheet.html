<input name="attr_sheet_type" type="hidden" class="sheet-type" value="Character">

<!--========[ Party Management sheet ]========-->

<main class="party">
  <section class="party-header">
    <div class="f-row f-center">
      <h3><span name="attr_character_name"></span></h3>
    </div>
    <div class="f-row">
      <label class="header-label" data-i18n="party-situation">Party's Situation:</label>
      <span><select name="attr_situation">
        <option data-i18n="tab-prepare" selected>Prepare</option>          
        <option data-i18n="tab-travel">Travel</option>          
        <option data-i18n="tab-explore">Explore</option>          
        <option data-i18n="tab-fight">Fight</option>          
      </select></span>
    </div>
  </section>
  <section class="party">
    <div class="party-line">
      <button type="action" class="party-char-name" name="act_select-char1"><span name="attr_name1"></span></button>
      <label class="party-char-ask">Ask them to roll:</label>
      <select type="text" class="party-char-skill" name="attr_prof1">
          <option data-i18-n="attack">Attack</option>
           <option data-i18-n="athletics">Athletics</option>
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="fortitude">Fortitude</option>
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>

           <option data-i18-n="stealth">Stealth</option>
           <option data-i18-n="finesse">Finesse</option>

           <option data-i18-n="arcana">Arcana</option>
           <option data-i18-n="crafting">Crafting</option>
           <option data-i18-n="lore">Lore</option>

           <option data-i18-n="animal-ken">Animal Ken</option>
           <option data-i18-n="medicine">Medicine</option>
           <option data-i18-n="nature">Nature</option>

           <option data-i18-n="Charm">Charm</option>
           <option data-i18-n="wit">Wit</option>
          </optgroup> 
      </select>
      <label class="party-char-vs"> vs. </label>
      <input type="text" class="party-char-dv" name="attr_vs1">
      <label class="party-char-done"><input type="checkbox" name="attr_done1"> Done</label>
    </div>
    <hr class="line">
    <div class="party-line">
      <button type="action" class="party-char-name" name="act_select-char2"><span name="attr_name2"></span></button>
      <label class="party-char-ask">Ask them to roll:</label>
      <select type="text" class="party-char-skill" name="attr_prof2">
          <option data-i18-n="attack">Attack</option>
          <optgroup label="Saving Throws">
           <option data-i18-n="athletics">Athletics</option>
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="fortitude">Fortitude</option>
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup>
          <optgroup label="Dexterity">
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="stealth">Stealth</option>
           <option data-i18-n="finesse">Finesse</option>
          </optgroup>
          <optgroup label="Intelligence">
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup> 
          <optgroup label="Wisdom">
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="animal-ken">Animal Ken</option>
           <option data-i18-n="medicine">Medicine</option>
           <option data-i18-n="nature">Nature</option>
          </optgroup> 
          <optgroup label="Charisma">
           <option data-i18-n="willpower">Willpower</option>
           <option data-i18-n="Charm">Charm</option>
           <option data-i18-n="wit">Wit</option>
          </optgroup> 
      </select>
      <label class="party-char-vs"> vs. </label>
      <input type="text" class="party-char-dv" name="attr_vs2">
      <label class="party-char-done"><input type="checkbox" name="attr_done2"> Done</label>
    </div>
    <hr class="line">
    <div class="party-line">
      <button type="action" class="party-char-name" name="act_select-char3"><span name="attr_name3"></span></button>
      <label class="party-char-ask">Ask them to roll:</label>
      <select type="text" class="party-char-skill" name="attr_prof3">
          <option data-i18-n="attack">Attack</option>
          <optgroup label="Saving Throws">
           <option data-i18-n="athletics">Athletics</option>
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="fortitude">Fortitude</option>
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup>
          <optgroup label="Dexterity">
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="stealth">Stealth</option>
           <option data-i18-n="finesse">Finesse</option>
          </optgroup>
          <optgroup label="Intelligence">
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup> 
          <optgroup label="Wisdom">
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="animal-ken">Animal Ken</option>
           <option data-i18-n="medicine">Medicine</option>
           <option data-i18-n="nature">Nature</option>
          </optgroup> 
          <optgroup label="Charisma">
           <option data-i18-n="willpower">Willpower</option>
           <option data-i18-n="Charm">Charm</option>
           <option data-i18-n="wit">Wit</option>
          </optgroup> 
      </select>
      <label class="party-char-vs"> vs. </label>
      <input type="text" class="party-char-dv" name="attr_vs3">
      <label class="party-char-done"><input type="checkbox" name="attr_done3"> Done</label>
    </div>
    <hr class="line">
    <div class="party-line">
      <button type="action" class="party-char-name" name="act_select-char4"><span name="attr_name4"></span></button>
      <label class="party-char-ask">Ask them to roll:</label>
      <select type="text" class="party-char-skill" name="attr_prof4">
          <option data-i18-n="attack">Attack</option>
          <optgroup label="Saving Throws">
           <option data-i18-n="athletics">Athletics</option>
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="fortitude">Fortitude</option>
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup>
          <optgroup label="Dexterity">
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="stealth">Stealth</option>
           <option data-i18-n="finesse">Finesse</option>
          </optgroup>
          <optgroup label="Intelligence">
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup> 
          <optgroup label="Wisdom">
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="animal-ken">Animal Ken</option>
           <option data-i18-n="medicine">Medicine</option>
           <option data-i18-n="nature">Nature</option>
          </optgroup> 
          <optgroup label="Charisma">
           <option data-i18-n="willpower">Willpower</option>
           <option data-i18-n="Charm">Charm</option>
           <option data-i18-n="wit">Wit</option>
          </optgroup> 
      </select>
      <label class="party-char-vs"> vs. </label>
      <input type="text" class="party-char-dv" name="attr_vs4">
      <label class="party-char-done"><input type="checkbox" name="attr_done4"> Done</label>
    </div>
    <hr class="line">
    <div class="party-line">
      <button type="action" class="party-char-name" name="act_select-char5"><span name="attr_name5"></span></button>
      <label class="party-char-ask">Ask them to roll:</label>
      <select type="text" class="party-char-skill" name="attr_prof5">
          <option data-i18-n="attack">Attack</option>
          <optgroup label="Saving Throws">
           <option data-i18-n="athletics">Athletics</option>
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="fortitude">Fortitude</option>
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup>
          <optgroup label="Dexterity">
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="stealth">Stealth</option>
           <option data-i18-n="finesse">Finesse</option>
          </optgroup>
          <optgroup label="Intelligence">
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup> 
          <optgroup label="Wisdom">
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="animal-ken">Animal Ken</option>
           <option data-i18-n="medicine">Medicine</option>
           <option data-i18-n="nature">Nature</option>
          </optgroup> 
          <optgroup label="Charisma">
           <option data-i18-n="willpower">Willpower</option>
           <option data-i18-n="Charm">Charm</option>
           <option data-i18-n="wit">Wit</option>
          </optgroup> 
      </select>
      <label class="party-char-vs"> vs. </label>
      <input type="text" class="party-char-dv" name="attr_vs5">
      <label class="party-char-done"><input type="checkbox" name="attr_done5"> Done</label>
    </div>
    <hr class="line">
    <div class="party-line">
      <button type="action" class="party-char-name" name="act_select-char6"><span name="attr_name6"></span></button>
      <label class="party-char-ask">Ask them to roll:</label>
      <select type="text" class="party-char-skill" name="attr_prof6">
          <option data-i18-n="attack">Attack</option>
          <optgroup label="Saving Throws">
           <option data-i18-n="athletics">Athletics</option>
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="fortitude">Fortitude</option>
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup>
          <optgroup label="Dexterity">
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="stealth">Stealth</option>
           <option data-i18-n="finesse">Finesse</option>
          </optgroup>
          <optgroup label="Intelligence">
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup> 
          <optgroup label="Wisdom">
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="animal-ken">Animal Ken</option>
           <option data-i18-n="medicine">Medicine</option>
           <option data-i18-n="nature">Nature</option>
          </optgroup> 
          <optgroup label="Charisma">
           <option data-i18-n="willpower">Willpower</option>
           <option data-i18-n="Charm">Charm</option>
           <option data-i18-n="wit">Wit</option>
          </optgroup> 
      </select>
      <label class="party-char-vs"> vs. </label>
      <input type="text" class="party-char-dv" name="attr_vs6">
      <label class="party-char-done"><input type="checkbox" name="attr_done6"> Done</label>
    </div>
    <hr class="line">
    <div class="party-line">
      <button type="action" class="party-char-name" name="act_select-char7"><span name="attr_name7"></span></button>
      <label class="party-char-ask">Ask them to roll:</label>
      <select type="text" class="party-char-skill" name="attr_prof7">
          <option data-i18-n="attack">Attack</option>
          <optgroup label="Saving Throws">
           <option data-i18-n="athletics">Athletics</option>
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="fortitude">Fortitude</option>
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup>
          <optgroup label="Dexterity">
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="stealth">Stealth</option>
           <option data-i18-n="finesse">Finesse</option>
          </optgroup>
          <optgroup label="Intelligence">
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup> 
          <optgroup label="Wisdom">
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="animal-ken">Animal Ken</option>
           <option data-i18-n="medicine">Medicine</option>
           <option data-i18-n="nature">Nature</option>
          </optgroup> 
          <optgroup label="Charisma">
           <option data-i18-n="willpower">Willpower</option>
           <option data-i18-n="Charm">Charm</option>
           <option data-i18-n="wit">Wit</option>
          </optgroup> 
      </select>
      <label class="party-char-vs"> vs. </label>
      <input type="text" class="party-char-dv" name="attr_vs7">
      <label class="party-char-done"><input type="checkbox" name="attr_done7"> Done</label>
    </div>
    <hr class="line">
    <div class="party-line">
      <button type="action" class="party-char-name" name="act_select-char7"><span name="attr_name8"></span></button>
      <label class="party-char-ask">Ask them to roll:</label>
      <select type="text" class="party-char-skill" name="attr_prof8">
          <option data-i18-n="attack">Attack</option>
          <optgroup label="Saving Throws">
           <option data-i18-n="athletics">Athletics</option>
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="fortitude">Fortitude</option>
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup>
          <optgroup label="Dexterity">
           <option data-i18-n="reflex">Reflex</option>
           <option data-i18-n="stealth">Stealth</option>
           <option data-i18-n="finesse">Finesse</option>
          </optgroup>
          <optgroup label="Intelligence">
           <option data-i18-n="deduction">Deduction</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="willpower">Willpower</option>
          </optgroup> 
          <optgroup label="Wisdom">
           <option data-i18-n="perception">Perception</option>
           <option data-i18-n="animal-ken">Animal Ken</option>
           <option data-i18-n="medicine">Medicine</option>
           <option data-i18-n="nature">Nature</option>
          </optgroup> 
          <optgroup label="Charisma">
           <option data-i18-n="willpower">Willpower</option>
           <option data-i18-n="Charm">Charm</option>
           <option data-i18-n="wit">Wit</option>
          </optgroup> 
      </select>
      <label class="party-char-vs"> vs. </label>
      <input type="text" class="party-char-dv" name="attr_vs8">
      <label class="party-char-done"><input type="checkbox" name="attr_done8"> Done</label>
    </div>
  </section>

  <section class="party-desc">
    <textarea name="attr_desc" class="fullsize"></textarea>
  </section>
  
  <footer class="f-col f-center">
    <span style="font-color: white;" data-i18n="copyright">(C) Bakagaijin Productions</span>
  </footer>
</main party>

<!--========[ Character sheet ]========-->

<main class="character">
  <section class="header">
    <div class="f-row">
      <label class="header-label" data-i18n="name">Name:</label>
      <span><input name="attr_character_name" type="text" class="character-name"></span>
    </div>
    <div class="f-row nowrap">
      <label class="header-label" data-i18n="race">Race:</label>
      <span><select name="attr_race" class="character-race">
          <option data-i18n="human" value="human">Human</option>
          <option data-i18n="dwarf" value="dwarf">Dwarf</option>
          <option data-i18n="elf" value="elf">Elf</option>
          <option data-i18n="halfling" value="halfling">Halfling</option>
          <option data-i18n="goblin" value="goblin">Goblin</option>
          <option data-i18n="lizardfolk" value="lizardfolk">Lizardfolk</option>
          <option data-i18n="hen-ge" value="hen-ge">Hen-ge</option>
          <option data-i18n="satyr" value="satyr">Satyr</option>
          <option data-i18n="centaur" value="centaur">Centaur</option>
          <option data-i18n="genasi" value="genasi">Genasi</option>
      </select></span>
      <label class="header-label" data-i18n="bonuses">Bonuses:</label>
      <span><input name="attr_race_max" type="text" class="character-race"></span>
    </div>
  </section>

  <section class="group">
    <div class="f-row">
      <label class="header-label" data-i18n="party">Party:</label>
      <span><input name="attr_party" type="text" class="character-party"></span>
    </div>
  </section>
  
  <section class="level f-row nowrap">
    <span>
      <input type="hidden" name="attr_level" class="character-level" >
      <select name="attr_class" class="character-class">
        <option data-i18n="knight" value="knight">Knight</option>
        <option data-i18n="martial-artist" value="martial-artist">Martial Artist</option>
        <option data-i18n="berserker" value="berserker">Berserker</option>
        <option data-i18n="thief" value="thief">Thief</option>
        <option data-i18n="alchemist" value="alchemist">Alchemist</option>
        <option data-i18n="ranger" value="ranger">Ranger</option>
        <option data-i18n="bard" value="bard">Bard</option>
        <option data-i18n="wizard" value="wizard">Wizard</option>
        <option data-i18n="cleric" value="cleric">Cleric</option>
        <option data-i18n="druid" value="druid">Druid</option>
      </select>
      <span class="character-class" name="attr_class" data-i18n-dynamic></span>
    </span>
    <span>
      <select name="attr_level" class="character-level">
          <option value="0">&#x1F513;</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
      </select>
    </span>
  </section>

  <section class="actions f-col nowrap">
   <input type="hidden" name="attr_situation" class="situation-toggle">
   <div class="situationPanel">
   <div class="panelHeader">
    <button class="tab-prepare" type="action" name="act_prepare"><span data-i18n="tab-prepare">Prepare</span></button>
    <button class="tab-travel" type="action" name="act_travel"><span data-i18n="tab-travel">Travel</span></button>
    <button class="tab-explore" type="action" name="act_explore"><span data-i18n="tab-explore">Explore</span></button>
    <button class="tab-fight" type="action" name="act_fight"><span data-i18n="tab-fight">Fight</span></button>
   </div>  
   <div class="panel-prepare">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_research"><span data-i18n="research">Research</span></button>
      </span>
      <label class="description" data-i18n="research-description">Describe what information your character is looking for, and how they go about looking for it, then roll the skill(s) that the referee asks for.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_crafting"><span data-i18n="crafting">Crafting</span></button>
      </span>
      <label class="description" data-i18n="crafting-description">Describe what item or items your character wishes to make, then roll the skill(s) that the referee asks for.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_socialize"><span data-i18n="socialize">Socialize</span></button>
      </span>
      <label class="description" data-i18n="socialize-description">Play out the conversation with the referee, then roll the skill(s) that the referee asks for.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_manage"><span data-i18n="manage">Manage</span></button>
      </span>
      <label class="description" data-i18n="manage-description">Describe the actions that you direct your retinue to perform; the referee will manage their skill rolls.</label>
    </div> 
   </div panel-prepare>
   <div class="panel-travel">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_navigate"><span data-i18n="navigate">Navigate</span></button>
      </span>
      <label class="description">Describe your attempt to gather information about your surroundings, then roll the skill(s) that the referee asks for.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_travel"><span data-i18n="travel">Travel</span></button>
      </span>
      <label class="description" data-i18n="travel-description">Attempt to traverse one league of terrain. If there are obstacles, the referee will call for a skill roll to surmount them.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_travel"><span data-i18n="double-time">Double Time</span></button>
      </span>
      <label class="description" data-i18n="doubletime-description">Attempt to traverse multiple leagues of terrain in one hour, at the cost of accumulating fatigue.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_rest"><span data-i18n="rest">Rest</span></button>
      </span>
      <label class="description" data-i18n="rest-description">Resting spends one <b>hit die</b> to heal hit points and recover all <span name="attr_powername"></span>.<br>
      </label>
    </div> 
    <input type="hidden" name="attr_level" class="character-level" >
    <div class="f-row f-center">
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_hd1_max">
        <button class="proficiency" type="roll" name="roll_hd1" 
          value="&{template:rolls} {{title=Hit Die (@{hd1}@{con})}} {{name=@{character_name} }} {{roll= [[{1d1,@{hd1}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd1_max"></span></label>
      </span>
      &nbsp;
      <span class="rollbox show-l4"><input type="hidden" class="die-controller" name="attr_hd2_max">
        <button class="proficiency req-l4" type="roll" name="roll_hd2" 
          value="&{template:rolls} {{title=Hit Die (@{hd2}@{con})}} {{name=@{character_name} }} {{roll= [[{1d1,@{hd2}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd2_max"></span></label>
      </span>
      &nbsp;
      <span class="rollbox show-l7"><input type="hidden" class="die-controller" name="attr_hd3_max">
        <button class="proficiency req-l7" type="roll" name="roll_hd3" 
          value="&{template:rolls} {{title=Hit Die (@{hd3}@{con})}} {{name=@{character_name} }} {{roll= [[{1d1,@{hd3}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd3_max"></span></label>
      </span>
      &nbsp;
      <span class="rollbox show-l10"><input type="hidden" class="die-controller" name="attr_hd4_max">
        <button class="proficiency req-l10" type="roll" name="roll_hd4" 
          value="&{template:rolls} {{title=Hit Die (@{hd4}@{con})}} {{name=@{character_name} }} {{roll= [[{1d1,@{hd4}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd4_max"></span></label>
      </span>
    </div>   </div panel-travel>
   <div class="panel-explore">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_skill"><span data-i18n="interact">Interact</span></button>
      </span>
      <label class="description" data-i18n="interact-description">Describe what action your character performs, then roll the skill that the referee asks for.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_watch"><span data-i18n="watch">Watch</span></button>
      </span>
      <label class="description" data-i18n="watch-description">Keeping Watch helps keep the party safe from ambushes.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_rest"><span data-i18n="rest">Rest</span></button>
      </span>
      <label class="description" data-i18n="rest-description">Resting spends one <b>hit die</b> to heal hit points and recover all <span name="attr_powername"></span>.<br>
      </label>
    </div> 
    <input type="hidden" name="attr_level" class="character-level" >
    <div class="f-row f-center">
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_hd1_max">
        <button class="proficiency" type="roll" name="roll_hd1" 
          value="&{template:rolls} {{title=Hit Die (@{hd1}@{con})}} {{name=@{character_name} }} {{roll= [[{1d1,@{hd1}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd1"></span></label>
      </span>
      &nbsp;
      <span class="rollbox show-l4"><input type="hidden" class="die-controller" name="attr_hd2_max">
        <button class="proficiency req-l4" type="roll" name="roll_hd2" 
          value="&{template:rolls} {{title=Hit Die (@{hd2}@{con})}} {{name=@{character_name} }} {{roll= [[{1d1,@{hd2}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd2"></span></label>
      </span>
      &nbsp;
      <span class="rollbox show-l7"><input type="hidden" class="die-controller" name="attr_hd3_max">
        <button class="proficiency req-l7" type="roll" name="roll_hd3" 
          value="&{template:rolls} {{title=Hit Die (@{hd3}@{con})}} {{name=@{character_name} }} {{roll= [[{1d1,@{hd3}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd3"></span></label>
      </span>
      &nbsp;
      <span class="rollbox show-l10"><input type="hidden" class="die-controller" name="attr_hd4_max">
        <button class="proficiency req-l10" type="roll" name="roll_hd4" 
          value="&{template:rolls} {{title=Hit Die (@{hd4}@{con})}} {{name=@{character_name} }} {{roll= [[{1d1,@{hd4}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd4"></span></label>
      </span>
    </div>
   </div panel-explore>
 
   <div class="panel-fight">
    <div class="f-row nowrap">
      <label class="initiative" data-i18n="initiative">Initiative</label>
      <input type="text" name="attr_initiative" class="bigbox">
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="armor-defense" data-i18n="defense">Defense</label>
      <input name="attr_armor" type="text" class="armor">      
      <input class="dv-big" type="text" name="attr_defense">
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="damage" data-i18n="resistances">Resistances:</label>
      <input name="attr_resistances" type="text" class="resistances">
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="action" data-i18n="last-action">Last Action:</label>
      <label class="action"><span="attr_lastaction"></span></label>
    </div>
    <input type="hidden" name="attr_actiontab" class="action-toggle">
    <div class="actionPanel">
      <div class="panelHeader">
          <button class="tab-attack" type="action" name="act_attack"><span data-i18n="tab-attack">Attack</span></button>
          <button class="tab-defend" type="action" name="act_defend"><span data-i18n="tab-defend">Defend</span></button>
          <button class="tab-move" type="action" name="act_move"><span data-i18n="tab-move">Move</span></button>
          <button class="tab-react" type="action" name="act_react"><span data-i18n="tab-react">React</span></button>
          <button class="tab-feat" type="action" name="act_feat"><span data-i18n="tab-feat">Feats</span></button>
      </div>    
      <div class="panel-attack">
        <hr class="space">
        <div class="f-row nowrap">
          <label class="attacks"><span data-i18n="weapon-attacks">Weapon Attacks</span> (<span name="attr_attack_max"></span><span data-i18n="per-action">/action</span>)</label>
        <span class="rollbox"><input type="hidden" class="die-controller" name="attr_attack">
            <button class="proficiency attack" type="action" name="act_roll-attack">
            </button><label class="proficiency-die"><span name="attr_attack"></span></label>
        </span>
        </div>
        <hr class="line">
        <div>
          <div class="f-row nowrap">
            <input name="attr_activeweapon" type="radio" value="@{attack1_action}">
            <input name="attr_weapon1" type="text" class="weapon">
            <input name="attr_accuracy1" type="text" class="weapon-accuracy">
          </div>
          <hr class="space">
          <div class="f-row nowrap">
              <label class="damage" data-i18n="damage">Damage:</label><input name="attr_damage1" type="text" class="damage"><button class="damage" type="roll" name="roll_damage1" 
    	         value="&{template:rolls} {{subtitle=Damage: @{weapon1}}} {{title=@{character_name} }} {{roll= [[@{damage1}[damage] ]]}}">
              </button>
          </div>
        </div>
        <hr class="line">
        <div>
          <div class="f-row nowrap">
            <input name="attr_activeweapon" type="radio" value="@{attack2_action}">
            <input name="attr_weapon2" type="text" class="weapon">
            <input name="attr_accuracy2" type="text" class="weapon-accuracy">
          </div>
          <hr class="space">
          <div class="f-row nowrap">
              <label class="damage" data-i18n="damage">Damage:</label><input name="attr_damage2" type="text" class="damage"><button class="damage" type="roll" name="roll_damage2" 
  	           value="&{template:rolls} {{subtitle=Damage: @{weapon2}}} {{title=@{character_name} }} {{roll= [[@{damage2}[damage] ]]}}">
              </button>
          </div>
        </div>
      </div panel-attack>
      
      <div class="panel-move">
        <hr class="space">
        <div class="f-row">
            <label class="description"><b><span data-i18n="walk">Walk</span></b><br>
            <span data-i18n="walk-description" data-i18n-vars="<span name='attr_speed'></span>">You may move up to {{0}} paces freely as part of your action.</span></label>
        </div>
        <input type="hidden" class="athlete-feat-toggle" name="attr_featlist">
        <div class="f-row athlete">
            <label class="description"><b><span data-i18n="warrior-2">Superior Athlete</span></b><br>
            <span data-i18n="warrior-2-description">You may jump, climb, and swim freely as part of your normal movement during your action.</span></label>
        </div>
        <hr class="line sprint">
        <div class="f-row">
            <button type="action" class="action" name="act_sprint"><span data-i18n="sprint">Sprint</span></button>
            <label class="description"><span data-i18n="sprint-description" data-i18n-vars="<span name='attr_sprintspeed'></span>">You may use your action to dash up to {{0}} paces.</span></label>
        </div>
        <hr class="line climb">
        <div class="f-row climb nowrap">
            <button type="action" class="action" name="act_climb"><span data-i18n="climb">Climb</span></button>
            <label class="description"><span data-i18n="climb-description" data-i18n-vars="<span name='attr_climbspeed'></span>">You may use your action to climb up to {{0}} paces.</span></label>
        </div>
        <hr class="line swim">
        <div class="f-row swim nowrap">
            <button type="action" class="action" name="act_swim"><span data-i18n="swim">Swim</span></button>
            <label class="description"><span data-i18n="swim-description" data-i18n-vars="<span name='attr_swimspeed'></span>">You may use your action to swim up to {{0}} paces.</span></label>
        </div>
        <hr class="line jump">
        <div class="f-row jump nowrap">
            <button type="action" class="action" name="act_jump"><span data-i18n="jump">Jump</span></button>
            <label class="description"><span data-i18n="jump-description" data-i18n-vars="<span name='attr_jumpspeed'></span>">You may use your action to jump up to {{0}} paces.</span></label>
        </div>
      </div panel-move>
      
      <div class="panel-defend">
        <hr class="space">
        <div class="f-row">
            <button type="action" class="action" name="act_guard"><span data-i18n="guard">Guard</span></button>
            <label class="description">
                <span data-i18n="defensive-action-description">Use your action to re-roll your initiative. </span>
                <span data-i18n="guard-description">Regain your reaction whenever you successfully parry or hit with an opportunity attack.</span>
            </label>
        </div>
        <hr class="line">
        <input type="hidden" class="elusive-feat-toggle" name="attr_featlist">
        <div class="f-row elusive">
            <label class="description"><b><span data-i18n="thief-2">Elusive</span></b><br>
            <span data-i18n="thief-2-description">You may choose to evade or hide as part of your normal action (choose one).</span></label>
        </div>
        <div class="f-row elusive">
            <input type="radio" name="sub-action" value="evade">
            <label class="description"><b><span data-i18n="evade">Evade</span></b> - 
            <span data-i18n="evade-description">Regain your reaction whenever you successfully dodge.</span></label>
        </div>
        <div class="f-row elusive">
            <input type="radio" name="sub-action" value="hide">
            <label class="description"><b><span data-i18n="hide">Hide</span></b> - 
            <span data-i18n="hide-description">Roll Stealth to become hidden</span></label>
        </div>
        <div class="f-row elusive">
            <button type="action" class="action" name="act_hide"><span data-i18n="hide-evade">Both</span></button>
            <label class="description" data-i18n="hide-evade-description">Hide and Evade (this uses your action)</label>
        </div>
        <div class="f-row evade">
            <button type="action" class="action" name="act_evade"><span data-i18n="evade">Evade</span></button>
            <label class="description">
                <span data-i18n="defensive-action-description">Use your action to re-roll your initiative. </span>
                <span class="description" data-i18n="evade-description">Regain your reaction after you successfully dodge</span>
            </label>
        </div>
        <hr class="line">
        <div class="f-row evade">
            <button type="action" class="action" name="act_hide"><span data-i18n="hide">Hide</span></button>
            <label class="description" data-i18n="hide-description">Roll Stealth to become hidden</label>
        </div>
      </div panel-defend>
      
      <div class="panel-react">
        <hr class="space">
        <div class="f-row"><input type="hidden" class="die-controller" name="attr_attack">
          <button class="opportunity-attack reaction" type="action" name="act_opp-attack" value="@{activeweapon}"></button>
          <label class="description"><b><span data-i18n="opportunity-attack">Opportunity Attack</span></b><br>
          <span data-i18n="opportunity-attack-description">Attack with your current weapon.</span></label>
        </div> 
        <hr class="line">
        <input type="hidden" class="deflect-feat-toggle" name="attr_featlist">
        <div class="f-row deflect"><input type="hidden" class="die-controller" name="attr_attack">
          <button class="defend reaction" type="action" name="act_roll-deflect"></button>
          <label class="description"><b><span data-i18n="deflect">Deflect</span></b><br>
          <span data-i18n="deflect-description" data-i18n-vars="<span name='attr_reflex'></span>|<span name='attr_attack'></span>">Add <b><span name="attr_reflex"></span>+<span name="attr_attack"></span></b> to your Defense vs one attack.</span></label>
        </div> 
        <div class="f-row dodge"><input type="hidden" class="die-controller" name="attr_reflex">
          <button class="defend reaction" type="action" name="act_roll-dodge" 
   	        value="&{template:rolls} {{subtitle=Dodge}} {{title=@{character_name} }} {{roll= [[@{defense}+@{reflex}[reflex] ]]}}"></button>
          <label class="description"><b><span data-i18n="dodge">Dodge</span></b><br>
          <span data-i18n="dodge-description" data-i18n-vars="<span name='attr_reflex'></span>">Add <b><span name="attr_reflex"></span></b> to your Defense vs one attack.</span></label>
        </div> 
        <hr class="line">
        <div class="f-row parry"><input type="hidden" class="die-controller" name="attr_attack">
          <button class="defend reaction" type="action" name="act_roll-parry" 
   	        value="&{template:rolls} {{subtitle=Parry (@{weapon2})}} {{title=@{character_name} }} {{roll=[[@{defense}+@{parry2}+@{attack}[attack] ]]}}"></button>
          <label class="description"><b><span data-i18n="parry">Parry</span> (<span name="attr_weapon2"></span>)</b><br>
          <span data-i18n="parry-description" data-i18n-vars="<span name='attr_attack'></span>|<span name='attr_parry2'></span>">Add <b><span name="attr_attack"></span><span name="attr_parry2"></span></b>
          to your Defense vs one melee attack (or vs one ranged attack if you are using a shield).</span></label>
        </div> 
      </div panel-react>
      
      <div class="panel-feat">
        <input type="hidden" name="attr_power_max" class="power-max" >
        <div class="f-row nowrap show-power">
        <label class="ability"><span name="attr_powername" data-i18n-dynamic ></span></label>
        <span class="blockbox">
            <input class="bigbox" type="text" name="attr_power">
            <span style="font-size: 18px; font-style: bold;"><b>/</b></span>
            <input class="bigbox" readonly name="attr_power_max"></span>
        </div>    
      </div panel-feat>
    </div actionPanel>
   </div panel-fight>
   
  </div situationPanel>
  </section>


  <section class="str f-col nowrap">
    <div class="f-row nowrap">
      <input type="hidden" name="attr_level" class="character-level" >
      <select name="attr_strength" class="ability-score">
        <option value="roll">&#x2685;</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <div class="ability-score"><span name="attr_strength"></span></div>
      <label class="ability" data-i18n="strength">Strength</label>
      <div class="ability-mod"><span name="attr_str"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save athletics"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-athletics">+</button>
      </span>&nbsp;<span  data-i18n="athletics">Athletics</span></label>
      <label class="dv"><span name="attr_athletics-dv"></span></label> 
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_athletics">
        <button class="proficiency save athletics" type="action" name="act_roll-athletics">
        </button><label class="proficiency-die"><span name="attr_athletics"></span></label>
      </span>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="ability" data-i18n="encumbrance">Encumbrance</label>
      <input name="attr_encumbrance" type="text" class="bigbox">
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="action"><span name="attr_movement" data-i18n-dynamic></span> <span data-i18n="speed">Speed</span></label>
      <span name="attr_move" class="bigbox"></span>
    </div>
  </section>

  <section class="dex f-col nowrap">
    <div class="f-row nowrap">
      <input type="hidden" name="attr_level" class="character-level" >
      <select name="attr_dexterity" class="ability-score">
        <option value="roll">&#x2685;</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <div class="ability-score"><span name="attr_dexterity"></span></div>
      <label class="ability" data-i18n="dexterity">Dexterity</label>
      <div class="ability-mod"><span name="attr_dex"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save reflex"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-reflex">+</button>
      </span>&nbsp;<span  data-i18n="reflex">Reflex</span></label>
      <label class="dv"><span name="attr_reflex-dv"></span></label> 
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_reflex">
        <button class="proficiency save reflex" type="action" name="act_roll-reflex">
        </button><label class="proficiency-die"><span name="attr_reflex"></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill stealth"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-stealth">+</button>
      </span>&nbsp;<span  data-i18n="stealth">Stealth</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_stealth"> 
        <button class="proficiency skill stealth" type="action" name="act_roll-stealth">
        </button><label class="proficiency-die"><span name="attr_stealth"></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill finesse"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-finesse">+</button>
      </span>&nbsp;<span  data-i18n="finesse">Finesse</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_finesse">
        <button class="proficiency skill finesse" type="action" name="act_roll-finesse">
        </button><label class="proficiency-die"><span name="attr_finesse"></span></label>
      </span>
    </div>
  </section>

  <section class="con f-col nowrap">
    <div class="f-row nowrap">
      <input type="hidden" name="attr_level" class="character-level" >
      <select name="attr_constitution" class="ability-score">
        <option value="roll">&#x2685;</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <div class="ability-score"><span name="attr_constitution"></span></div>
      <label class="ability" data-i18n="constitution">Constitution</label>
      <div class="ability-mod"><span name="attr_con"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save fortitude"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-fortitude">+</button>
      </span>&nbsp;<span data-i18n="fortitude">Fortitude</span></label>
      <label class="dv"><span name="attr_fortitude-dv"></span></label> 
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_fortitude">
        <button class="proficiency save fortitude" type="action" name="act_roll-fortitude">
        </button><label class="proficiency-die"><span name="attr_fortitude"></span></label>
      </span>    
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="action nowrap"><span data-i18n="hit-points">Hit Points</span>:</label>
      <label class="action nowrap f-right"><input name="attr_temp-hitpoints" type="text" class="hp alt">+<input name="attr_hitpoints" type="text" class="hp">/<input name="attr_hitpoints_max" readonly class="hp"></label>      
    </div>
    <div class="f-row nowrap">
      <label class="action nowrap"><span data-i18n="fatigue">Fatigue</span>+<span data-i18n="wounds">Wounds</span>:</label>
      <label class="action nowrap f-right"><input name="attr_fatigue" type="text" class="wounds alt">+<input name="attr_wounds" type="text" class="wounds"></label>      
    </div>
  </section>

  <section class="int f-col nowrap">
    <div class="f-row nowrap">
      <input type="hidden" name="attr_level" class="character-level" >
      <select name="attr_intelligence" class="ability-score">
        <option value="roll">&#x2685;</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <div class="ability-score"><span name="attr_intelligence"></span></div>
      <label class="ability" data-i18n="intelligence">Intelligence</label>
      <div class="ability-mod"><span name="attr_int"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-deduction">+</button>
      </span>&nbsp;<span data-i18n="deduction">Deduction</span></label>
      <label class="dv"><span name="attr_deduction-dv"></span></label> 
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_deduction">
        <button class="proficiency save deduction" type="action" name="act_roll-deduction">
        </button><label class="proficiency-die"><span name="attr_deduction"></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill arcana"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-arcana">+</button>
      </span>&nbsp;<span data-i18n="arcana">Arcana</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_arcana">
        <button class="proficiency skill arcana" type="action" name="act_roll-arcana">
        </button><label class="proficiency-die"><span name="attr_arcana"></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill crafting"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-crafting">+</button>
      </span>&nbsp;<span data-i18n="crafting">Crafting</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_crafting">
        <button class="proficiency skill crafting" type="action" name="act_roll-crafting">
        </button><label class="proficiency-die"><span name="attr_crafting"></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill lore"><span class="skill-trainingbox">
        <button type="action" class="train-skill skill lore" name="act_train-lore">+</button>
      </span>&nbsp;<span data-i18n="lore">Lore</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_lore">
        <button class="proficiency skill lore" type="action" name="act_roll-lore">
        </button><label class="proficiency-die"><span name="attr_lore"></span></label>
      </span>
    </div>
  </section>

  <section class="wis f-col nowrap">
    <div class="f-row nowrap">
      <input type="hidden" name="attr_level" class="character-level" >
      <select name="attr_wisdom" class="ability-score">
        <option value="roll">&#x2685;</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <div class="ability-score"><span name="attr_wisdom"></span></div>
      <label class="ability" data-i18n="wisdom">Wisdom</label>
      <div class="ability-mod"><span name="attr_wis"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save perception"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-perception">+</button>
      </span>&nbsp;<span data-i18n="perception">Perception</span></label>
      <label class="dv"><span name="attr_perception-dv"></span></label> 
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_perception">
        <button class="proficiency save perception" type="action" name="act_roll-perception">
        </button><label class="proficiency-die"><span name="attr_perception"></span></label>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill animal-ken"><span class="skill-trainingbox">
        <button type="action" class="train-skill skill" name="act_train-animal-ken">+</button>
      </span>&nbsp;<span data-i18n="animal-ken">Animal Ken</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_animal-ken">
        <button class="proficiency skill animal-ken" type="action" name="act_roll-animal-ken">
        </button><label class="proficiency-die"><span name="attr_animal-ken"></span></label>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill nature"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-nature">+</button>
      </span>&nbsp;<span data-i18n="nature">Nature</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_nature">
        <button class="proficiency skill nature" type="action" name="act_roll-nature">
        </button><label class="proficiency-die"><span name="attr_nature"></span></label>
      </span>    
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill medicine"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-medicine">+</button>
      </span>&nbsp;<span data-i18n="medicine">Medicine</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_medicine">
        <button class="proficiency skill medicine" type="action" name="act_roll-medicine">
        </button><label class="proficiency-die"><span name="attr_medicine"></span></label>
      </span>    
    </div>
  </section>

  <section class="cha f-col nowrap">
    <div class="f-row nowrap">
      <input type="hidden" name="attr_level" class="character-level" >
      <select name="attr_charisma" class="ability-score">
        <option value="roll">&#x2685;</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select>      
      <div class="ability-score"><span name="attr_charisma"></span></div>
      <label class="ability" data-i18n="charisma">Charisma</label>
      <div class="ability-mod"><span name="attr_cha"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save willpower"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-willpower">+</button>
      </span>&nbsp;<span data-i18n="willpower">Willpower</span></label>
      <label class="dv"><span name="attr_willpower-dv"></span></label> 
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_willpower">
        <button class="proficiency save willpower" type="action" name="act_roll-willpower">
        </button><label class="proficiency-die"><span name="attr_willpower"></span></label>
      </span>    
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill charm"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-charm">+</button>
      </span>&nbsp;<span data-i18n="charm">Charm</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_charm">
        <button class="proficiency skill charm" type="action" name="act_roll-charm">
        </button><label class="proficiency-die"><span name="attr_charm"></span></label>
      </span>    
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill wit"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-wit">+</button>
      </span>&nbsp;<span data-i18n="wit">Wit</span></label>
      <span class="rollbox"><input type="hidden" class="die-controller" name="attr_wit">
        <button class="proficiency skill wit" type="action" name="act_roll-wit">
        </button><label class="proficiency-die"><span name="attr_wit"></span></label>
      </span>    
    </div>

  </section>

  <section class="feats f-col">
    <h3><span data-i18n="class-features">Class Features</span></h3>
    <input type="hidden" name="attr_featlist" class="character-featlist">  
    <input type="hidden" name="attr_level" class="character-level" >
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;1</label>
      <span class="flush"><label class="list-first"><span name="attr_l1feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;2</label>
      <span class="flush"><label class="list-middle req-l2"><span name="attr_l2feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;3</label>
      <span class="flush"><label class="list-middle req-l3"><span name="attr_l3feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;4</label>
      <span class="flush"><label class="list-middle req-l4"><span name="attr_l4feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;5</label>
      <span class="flush"><label class="list-middle req-l5"><span name="attr_l5feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;6</label>
      <span class="flush"><label class="list-middle req-l6"><span name="attr_l6feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;7</label>
      <span class="flush"><label class="list-middle req-l7"><span name="attr_l7feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;8</label>
      <span class="flush"><label class="list-middle req-l8"><span name="attr_l8feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;9</label>
      <span class="flush"><label class="list-middle req-l9"><span name="attr_l9feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">10</label>
      <span class="flush"><label class="list-last req-l10"><span name="attr_l10feat" data-i18n-dynamic></span></span>
    </div>
  </section>

  <section class="equipment">
    <h3><span data-i18n="equipment">Equipment</span></h3>
    <div class="f-row nowrap flush">
      <label class="equipment-slot flush" data-i18n="armor">Armor</label>
      <span class="flush"><input name="attr_eqarmor" type="text" class="list-first"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="equipment-slot flush" data-i18n="r-hand">R Hand</label>
      <span class="flush"><input name="attr_eqhand1" type="text" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="equipment-slot flush" data-i18n="l-hand">L Hand</label>
      <span class="flush"><input name="attr_eqhand2" type="text" class="list-last"></span>
    </div>
    <hr class="line">
    <div class="f-row nowrap flush">
      <label class="equipment-slot flush" data-i18n="crown">Crown</label>
      <span class="flush"><input name="attr_eqcrown" type="text" class="list-first"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="equipment-slot flush" data-i18n="amulet">Amulet</label>
      <span class="flush"><input name="attr_eqamulet" type="text" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="equipment-slot flush"><span data-i18n="ring">Ring</span> <span style="font-size: 67%;">(R)</span></label>
      <span class="flush"><input name="attr_eqring1" type="text" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="equipment-slot flush"><span data-i18n="ring">Ring</span> <span style="font-size: 67%;">(L)</span></label>
      <span class="flush"><input name="attr_eqring2" type="text" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="equipment-slot flush" data-i18n="belt">Belt</label>
      <span class="flush"><input name="attr_eqbelt" type="text" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="equipment-slot flush" data-i18n="boots">Boots</label>
      <span class="flush"><input name="attr_eqboots" type="text" class="list-last"></span>
    </div>
  </section>

  <section class="inventory">
    <h3><span data-i18n="inventory">Inventory</span></h3>
    <textarea name="attr_inventory" class="inventory"></textarea>
  </section>

  <footer class="f-col f-center">
    <span style="font-color: white;" data-i18n="copyright">(C) Bakagaijin Productions</span>
  </footer>
</main character>

<!-------------------======================= javascript =======================------------------->
<script type="text/worker">

/*===== tabbed functionality =====*/
    const situationTabs = ["travel", "explore", "fight", "prepare"];
    situationTabs.forEach(tab => {
        on(`clicked:${tab}`, function() {
            console.log("  clicked " + tab);
            setAttrs({ situation: tab });
            let mode = "";
            if(tab == "fight") mode = "d20";
            setAttrs({ d20: mode });
        });
    });

    const actionTabs = ["attack", "move", "defend", "react", "feat"];
    actionTabs.forEach(tab => {
        on(`clicked:${tab}`, function() {
            console.log("  clicked " + tab);
            setAttrs({ actiontab: tab });
        });
    });

    const moveTabs = ["walk", "sprint", "climb", "swim", "jump"];
    moveTabs.forEach(tab => {
        on(`clicked:${tab}`, function() {
            let moveType = tab; if(tab == "walk") moveType = "";
    		var attrsToChange = {};
            getAttrs([moveType+"speed", "move"], function(values) {
                console.log("  clicked " + tab + "; retrieving " + moveType+"speed (" + values[moveType+"speed"] + ")");
                attrsToChange["move"] = values[moveType+"speed"];
                attrsToChange["movement"] = tab;
        		setAttrs(attrsToChange);
            });
        });
    });


/*===== auto-computing fields =====*/
    const abilities = ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"];
    abilities.forEach(ability => { on(`change:${ability}`, function() { updatemod(ability); }); });
 
    const saves = ["athletics", "reflex", "fortitude", "deduction", "perception","willpower"];
    saves.forEach(save => { on(`change:${save}`, function() { updatedv(save); }); });

    const skills = ["athletics", 
                    "reflex", "stealth", "finesse",
                    "fortitude", 
                    "deduction", "arcana", "crafting", "lore",
                    "perception", "animal-ken", "nature", "medicine",
                    "willpower", "charm", "wit"];
    skills.forEach(skill => { 
        on(`clicked:train-${skill}`, function() { train(skill); }); 
        on(`clicked:roll-${skill}`, function() { rollSkill(skill); }); 

    });

    on(`clicked:roll-attack`, function(eventInfo) { rollAttack(""); });
    on(`clicked:opp-attack`, function(eventInfo) { rollAttack("Opportunity"); });
    on(`clicked:roll-dodge`, function(eventInfo) { rollDodge(); });
    on(`clicked:roll-parry`, function(eventInfo) { rollParry(); });
    on(`clicked:roll-deflect`, function(eventInfo) { rollDeflect(); });
    
    on("change:character_name", function(eventInfo) { setupActions(); });
    on("change:race", function(eventInfo) { setupRace(); });
    on("change:class", function(eventInfo) { setupClass(); });
    on("change:level", function(eventInfo) { validate(); });
    on(`change:fatigue`, function(eventInfo) { recalcWounds() });
    on(`change:wounds`, function(eventInfo) { recalcWounds() });
    
    on("sheet:opened", function() {
      initialize();    
      getAttrs(["sheet_type"], function(values) {
        let sheetType = String(values["sheet_type"]).toLowerCase();
        if(sheetType.includes("character")) {
          setupClass();
          validate();
          abilities.forEach(ability => { updatemod(ability); });
          saves.forEach(save => { updatedv(save); });
        }
      });
    });
 
    const levelUpData = ["class", "class_max", "level", "featlist", "constitution", "con", "hd1", "hd2", "hd3", "hd4", 
                        "l1feat", "l2feat", "l3feat", "l4feat", "l5feat", "l6feat", "l7feat", "l8feat", "l9feat", "l10feat",
                        "l1feat_max", "l2feat_max", "l3feat_max", "l4feat_max", "l5feat_max", "l6feat_max", "l7feat_max", "l8feat_max", "l9feat_max", "l10feat_max" ];

    var raceTable = [];
    var raceTable2 = [];
    var raceData = {};
    var classData = {};

    const untrained = "", untrainedDie = "0";
    const rules_dv_levels = "?{Difficulty|None,0|Easy,10|Average,15|Hard,20|Extreme,25|Legendary,30|Custom,?{Enter DV}}";
    const rules_cof_levels = "?{Chance of Failure|None,0|Easy,2|Average,4|Hard,6|Extreme,8|Legendary,10|Custom,?{Enter CoF}}";//"?{Chance of Failure|None,0|Easy,2d4kh1[2]|Average,2d6kh1[3]|Hard,2d8kh1[4]|Extreme,2d10kh1[5]|Legendary,2d12kh1[6]|Custom,?{Enter CoF}}";

    function initialize() {
        console.log("---=== initializing race and class data ===---");
        
        var loadRace = {};
        loadRace[""] = "none";
        
        raceData["human"] = "none";
        raceData["dwarf"] = "Con, Str";
        raceData["elf"] = "Dex, Wis";
        raceData["halfling"] = "Dex, Cha";
        raceData["hen-ge"] = "none";
        raceData["goblin"] = "Dex, Con";
        raceData["lizardfolk"] = "Dex, Str";
        raceData["centaur"] = "Str, Wis";
        raceData["satyr"] = "Cha, Wis";
        raceData["genasi"] = "Con, Wis";

        raceTable[1] = "human";
        raceTable[2] = "human";
        raceTable[3] = "human";
        raceTable[4] = "human";
        raceTable[5] = "human";
        raceTable[6] = "human";
        raceTable[7] = "human";
        raceTable[8] = "human";
        raceTable[9] = "human";
        raceTable[10] = "human";
        raceTable[11] = "dwarf";
        raceTable[12] = "dwarf";
        raceTable[13] = "dwarf";
        raceTable[14] = "dwarf";
        raceTable[15] = "elf";
        raceTable[16] = "elf";
        raceTable[17] = "elf";
        raceTable[18] = "halfling";
        raceTable[19] = "halfling";
        raceTable[20] = "*";
        
        raceTable2[1] = "goblin";
        raceTable2[2] = "goblin";
        raceTable2[3] = "goblin";
        raceTable2[4] = "goblin";
        raceTable2[5] = "goblin";
        raceTable2[6] = "lizardfolk";
        raceTable2[7] = "lizardfolk";
        raceTable2[8] = "lizardfolk";
        raceTable2[9] = "genasi";
        raceTable2[10] = "genasi";
        raceTable2[11] = "genasi";
        raceTable2[12] = "hen-ge";
        raceTable2[13] = "hen-ge";
        raceTable2[14] = "hen-ge";
        raceTable2[15] = "satyr";
        raceTable2[16] = "satyr";
        raceTable2[17] = "satyr";
        raceTable2[18] = "centaur";
        raceTable2[19] = "centaur";
        raceTable2[20] = "centaur";
        
        
        var loadClass = {};
        loadClass["class_max"] = "knight";
        loadClass["hd1"] = "d10";
        loadClass["hd2"] = "d10";
        loadClass["hd3"] = "d10";
        loadClass["hd4"] = "d10";
        loadClass["l1feat"] = "warrior-1, knight-1";
        loadClass["l2feat"] = "warrior-2";
        loadClass["l3feat"] = "knight-3";
        loadClass["l4feat"] = "warrior-4";
        loadClass["l5feat"] = "warrior-5";
        loadClass["l6feat"] = "knight-6";
        loadClass["l7feat"] = "warrior-7";
        loadClass["l8feat"] = "warrior-8";
        loadClass["l9feat"] = "warrior-9";
        loadClass["l10feat"] = "warrior-10";
        loadClass["l1feat_max"] = "athletics, fortitude, animal-ken";
        loadClass["l2feat_max"] = "athletics, fortitude, reflex";
        loadClass["l3feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l4feat_max"] = "choose(any)";
        loadClass["l5feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l6feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l7feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l8feat_max"] = "choose(any)";
        loadClass["l9feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l10feat_max"] = "choose(any)";
        classData["knight"] = JSON.parse(JSON.stringify(loadClass));

        loadClass["class_max"] = "martial-artist";
        loadClass["l1feat"] = "warrior-1, martial-artist-1";
        loadClass["l3feat"] = "martial-artist-3";
        loadClass["l6feat"] = "martial-artist-6";
        loadClass["l1feat_max"] = "athletics, reflex, perception";
        classData["martial-artist"] = JSON.parse(JSON.stringify(loadClass));
        
        loadClass["class_max"] = "berserker";
        loadClass["l1feat"] = "warrior-1, berserker-1";
        loadClass["l3feat"] = "berserker-3";
        loadClass["l6feat"] = "berserker-6";
        loadClass["l1feat_max"] = "athletics, reflex, fortitude";
        classData["berserker"] = JSON.parse(JSON.stringify(loadClass));
        
        loadClass["class_max"] = "thief";
        loadClass["hd1"] = "d8";
        loadClass["hd2"] = "d8";
        loadClass["hd3"] = "d8";
        loadClass["hd4"] = "d8";
        loadClass["l1feat"] = "expert-1, thief-1";
        loadClass["l2feat"] = "thief-2";
        loadClass["l3feat"] = "expert-3";
        loadClass["l4feat"] = "expert-4";
        loadClass["l5feat"] = "thief-5";
        loadClass["l6feat"] = "thief-6";
        loadClass["l7feat"] = "expert-7";
        loadClass["l8feat"] = "expert-8";
        loadClass["l9feat"] = "thief-9";
        loadClass["l10feat"] = "expert-10";
        loadClass["l1feat_max"] = "reflex, stealth, finesse, perception, choose(reflex, stealth, finesse, perception)";
        loadClass["l2feat_max"] = "choose(any), choose(any)";
        loadClass["l3feat_max"] = "choose(any), choose(any)";
        loadClass["l4feat_max"] = "choose(any), choose(any)";
        loadClass["l5feat_max"] = "choose(any), choose(any)";
        loadClass["l6feat_max"] = "choose(any), choose(any)";
        loadClass["l7feat_max"] = "choose(any), choose(any)";
        loadClass["l8feat_max"] = "choose(any), choose(any)";
        loadClass["l9feat_max"] = "choose(any), choose(any)";
        loadClass["l10feat_max"] = "choose(any), choose(any)";
        classData["thief"] = JSON.parse(JSON.stringify(loadClass));

        loadClass["class_max"] = "alchemist";
        loadClass["l1feat"] = "expert-1, alchemist-1";
        loadClass["l2feat"] = "alchemist-2";
        loadClass["l5feat"] = "alchemist-5";
        loadClass["l6feat"] = "alchemist-6";
        loadClass["l9feat"] = "alchemist-9";
        loadClass["l1feat_max"] = "arcana, crafting, finesse, medicine, choose(arcana, crafting, finesse, medicine)";
        classData["alchemist"] = JSON.parse(JSON.stringify(loadClass));

        loadClass["class_max"] = "ranger";
        loadClass["l1feat"] = "expert-1, ranger-1";
        loadClass["l2feat"] = "ranger-2";
        loadClass["l5feat"] = "ranger-5";
        loadClass["l6feat"] = "ranger-6";
        loadClass["l9feat"] = "ranger-9";
        loadClass["l1feat_max"] = "nature, animal-ken, stealth, perception,  choose(nature, animal-ken, stealth, perception)";
        classData["ranger"] = JSON.parse(JSON.stringify(loadClass));

        loadClass["class_max"] = "bard";
        loadClass["l1feat"] = "expert-1, bard-1";
        loadClass["l2feat"] = "bard-2";
        loadClass["l5feat"] = "bard-5";
        loadClass["l6feat"] = "bard-6";
        loadClass["l9feat"] = "bard-9";
        loadClass["l1feat_max"] = "charm, wit, finesse, lore, choose(charm, wit, finesse, lore)";
        classData["bard"] = JSON.parse(JSON.stringify(loadClass));

        loadClass["class_max"] = "druid";
        loadClass["l1feat"] = "druid-1";
        loadClass["l2feat"] = "druid-2";
        loadClass["l3feat"] = "druid-3";
        loadClass["l4feat"] = "druid-4";
        loadClass["l5feat"] = "druid-5";
        loadClass["l6feat"] = "druid-6";
        loadClass["l7feat"] = "druid-7";
        loadClass["l8feat"] = "druid-8";
        loadClass["l9feat"] = "druid-9";
        loadClass["l10feat"] = "druid-10";
        loadClass["l1feat_max"] = "nature, animal-ken";
        loadClass["l2feat_max"] = "choose(willpower, fortitude, lore, medicine, perception)";
        loadClass["l3feat_max"] = "choose(nature, animal-ken)";
        loadClass["l4feat_max"] = "choose(any)";
        loadClass["l5feat_max"] = "choose(nature, animal-ken)";
        loadClass["l6feat_max"] = "choose(nature, animal-ken, willpower, fortitude, lore, medicine, perception)";
        loadClass["l7feat_max"] = "choose(nature, animal-ken)";
        loadClass["l8feat_max"] = "choose(any)";
        loadClass["l9feat_max"] = "choose(nature, animal-ken)";
        loadClass["l10feat_max"] = "choose(nature, animal-ken, willpower, fortitude, lore, medicine, perception)";
        classData["druid"] = JSON.parse(JSON.stringify(loadClass));
        
        loadClass["class_max"] = "wizard";
        loadClass["hd1"] = "d4";
        loadClass["hd2"] = "d4";
        loadClass["hd3"] = "d4";
        loadClass["hd4"] = "d4";
        loadClass["l1feat"] = "wizard-1";
        loadClass["l2feat"] = "wizard-2";
        loadClass["l3feat"] = "wizard-3";
        loadClass["l4feat"] = "wizard-4";
        loadClass["l5feat"] = "wizard-5";
        loadClass["l6feat"] = "wizard-6";
        loadClass["l7feat"] = "wizard-7";
        loadClass["l8feat"] = "wizard-8";
        loadClass["l9feat"] = "wizard-9";
        loadClass["l10feat"] = "wizard-10";
        loadClass["l1feat_max"] = "arcana, deduction";
        loadClass["l2feat_max"] = "choose(willpower, lore, finesse, perception)";
        loadClass["l3feat_max"] = "arcana";
        loadClass["l4feat_max"] = "choose(any)";
        loadClass["l5feat_max"] = "arcana";
        loadClass["l6feat_max"] = "choose(deduction, willpower, lore, finesse, perception)";
        loadClass["l7feat_max"] = "arcana";
        loadClass["l8feat_max"] = "choose(any)";
        loadClass["l9feat_max"] = "arcana";
        loadClass["l10feat_max"] = "choose(deduction, willpower, lore, finesse, perception)";
        classData["wizard"] = JSON.parse(JSON.stringify(loadClass));


        loadClass["class_max"] = "cleric";
        loadClass["l1feat"] = "cleric-1";
        loadClass["l2feat"] = "cleric-2";
        loadClass["l3feat"] = "cleric-3";
        loadClass["l4feat"] = "cleric-4";
        loadClass["l5feat"] = "cleric-5";
        loadClass["l6feat"] = "cleric-6";
        loadClass["l7feat"] = "cleric-7";
        loadClass["l8feat"] = "cleric-8";
        loadClass["l9feat"] = "cleric-9";
        loadClass["l10feat"] = "cleric-10";
        loadClass["l1feat_max"] = "willpower, perception";
        loadClass["l2feat_max"] = "choose(charm, fortitude, lore, medicine)";
        loadClass["l3feat_max"] = "willpower, choose(perception, charm, fortitude, lore, medicine, arcana, athletics, deduction, nature, reflex)";
        loadClass["l4feat_max"] = "choose(any)";
        loadClass["l5feat_max"] = "willpower";
        loadClass["l6feat_max"] = "choose(perception, charm, fortitude, lore, medicine, *domain)";
        loadClass["l7feat_max"] = "willpower";
        loadClass["l8feat_max"] = "choose(any)";
        loadClass["l9feat_max"] = "willpower";
        loadClass["l10feat_max"] = "choose(perception, charm, fortitude, lore, medicine, *domain)";
        classData["cleric"] = JSON.parse(JSON.stringify(loadClass));
    }
    
    function setupRace() {
        getAttrs(["race"], function(values) {
            setAttrs({ "race_max": raceData[values["race"]] });
        });
        validate();
    }
    
    function setupClass() {
        getAttrs(levelUpData, function(values) {
            if(values["featlist"]==undefined) {
                console.log("---=== NEW CHARACTER DETECTED ===---");
                if(values["class"]==undefined) {
                    console.log("---=== NO CLASS CHOSEN ===---");
                } else {
                    setAttrs(classData[values["class"]]);
                }
            }
            let level = values["level"];
            if(level == undefined || level == 0) {
                newClass = values["class"];
                console.log("WARNING! Changing class to " + newClass);
                setAttrs(classData[newClass]);
            } else if(values["class"] != values["class_max"]) { 
                // undo the change
                console.log("WARNING! Changing class back to " + values["class_max"]);
                //setAttrs({ "class": values["class_max"] });
            }
        });
        validate();
    }

/* -----===== Character Validator ======------ 
   This function contains all the logic for building the character 
   based on level, feat choices, and skill training choices. These
   choices are recorrded in the l1feat - l10feat attributes -- the
   l#feat stores the class feat choice, and the l#feat_max stores
   the skill training choice(s). 
   
   A class feat will look like this:  
   
   "knight-1" 
   
   - this indicates the level 1 knight class feat. 
   (The translation.js file will contain the text names and 
   descriptions for each choice.)

   Skill training  will look like this: 
   
   "athletics, animal-ken" -
   
   - this indicates that both the athletics and animal-ken feats
   get raised at this level. 
   
   If a class level allows a choice of what skill(s) to train, the 
   choice will look like this: 
   
   "choose(crafting, lore, arcana)" 
   
   - this indicates that the player can choose between the crafting,
   lore, or arcana skills for this choice. 
   
   A choice might also look like this: 
   
   "choose(any)"
   
   - indicating any skill may be chosen.
   
   Once they choose, this entire choice(...) block will be removed 
   from the l#feat_max attribute, and replaced with the skill chosen. 
   
   A l#feat_max entry can contain both skill training, and pending
   choices, like so: 
   
   "athletics, reflex, choose(any), choose(lore, arcana)"
   
   When the player makes a skill choice, the train() function will 
   find the first matching choose(...) block, and replace it with 
   that choice.
*/
    function validate() {
        getAttrs(["character_name"], function(values) {
            console.log("---=== validating " + values["character_name"] + " ===---");
        });
        getAttrs(levelUpData, function(values) {
            if(values["l1feat"] == undefined) {
                console.log("UNINITIALIZED CHARACTER! Aborting validation.");
                return;
            }
            let level = values["level"];
            let hitDice = Math.floor(level/3+.667);
            console.log("level " + level + " " + values["class"] + " (" + hitDice + "hd)");

            // work out maximum HP for this class and level
            let hpBonus = die2dv(values["hd1"]) + 1.0*values["con"];
            if(hpBonus < 1) hpBonus = 1;
            let maxHP = Math.floor(0.5*values["constitution"]) + hpBonus * level;
            /*
            let maxHP = Math.floor(0.5*values["constitution"]);
            for(let i = 1; i <= hitDice; i++) {
                let hpBonus = die2dv(values["hd"+i]) + 1.0*values["con"];
                if(hpBonus < 1) hpBonus = 1;
                console.log("hd" + i + ":"+ values["hd"+i] + values["con"] + " (" + hpBonus + ")");
                maxHP += hpBonus;
            }*/
            console.log("max hitpoints: " + maxHP);
            let power = "";
            let domainSkill = "";
            let feats = values["l1feat"];
            let skillList = values["l1feat_max"];
            let skillOptions = "";
            if(skillList.includes("choose(")) {
                let splitArray = skillList.split("choose(");
                skillList = splitArray[0];
                for(let i=1; i<splitArray.length; i++) skillOptions += "choose(" + splitArray[i];
            }
            for(let i=2; i<=level;i++) {
                let feat = values["l"+i+"feat"];
                let skill = values["l"+i+"feat_max"];
                console.log(feat);
                feats += ", " + feat;
                
                // level 3 feats always grant a class's encounter power, except for wizards.
                if(power == "" && feat.includes("-3") && !(feat == "wizard-3")) power = feat;
                
                // many class levels allow for a skill choice, while others simply grant specific skills
                if(skill.includes("choose(")) {
                    if(skill.includes("*domain") && domainSkill > "") {
                        skill = skill.replace("*domain", domainSkill); 
                        setAttrs({ ["l"+i+"feat_max"]: skill });
                    }
                    
                    let splitArray = skill.split("choose(");
                    if(splitArray[0] > "") skillList += ", " + splitArray[0];
                    for(let i=1; i<splitArray.length; i++) {
                        if(skillOptions > "") skillOptions += ", ";
                        skillOptions += "choose(" + splitArray[i];
                    }
                } else { // keep a running tally of all granted and chosen skills
                    skillList += ", " + skill;
                    if(feat.includes("cleric-3")) { // choose() has already been chosen; this determines our Domain
                        domainSkill = skill.split(", ")[1];
                        console.log("domain skill: " + domainSkill);
                        if(domainSkill == "perception") {
                            domainFeat = "cleric-3-peace";
                        } else if(domainSkill == "athletics") {
                            domainFeat = "cleric-3-war";
                        } else if(domainSkill == "medicine") {
                            domainFeat = "cleric-3-death";
                        } else if(domainSkill == "fortitude") {
                            domainFeat = "cleric-3-life";
                        } else if(domainSkill == "charm") {
                            domainFeat = "cleric-3-beauty";
                        } else if(domainSkill == "deduction") {
                            domainFeat = "cleric-3-truth";
                        } else if(domainSkill == "lore") {
                            domainFeat = "cleric-3-fate";
                        } else if(domainSkill == "reflex") {
                            domainFeat = "cleric-3-freedom";
                        } else if(domainSkill == "nature") {
                            domainFeat = "cleric-3-nature";
                        } else if(domainSkill == "arcana") {
                            domainFeat = "cleric-3-artifice";
                        }
                        setAttrs({ ["l"+i+"feat"]: domainFeat });
                    }
                } 
            }
            console.log(feats);
            console.log(skillList);
            console.log(skillOptions);

            let powerMax = hitDice;
            if(power == "") powerMax = 0;
            
            let attacks = 1;
            if(feats.includes("warrior-9")) attacks =3;
            else if(feats.includes("warrior-5")) attacks =2;
            
            var attackDie; // set Attack Die from best class and level
            if(feats.includes("warrior-10")) { 
                attackDie = "d12";
            } else if(feats.includes("warrior-7")) { 
                attackDie = "d10";
            } else if(feats.includes("warrior-4")
                    || feats.includes("expert-9") 
                    || feats.includes("thief-9") 
                    || feats.includes("bard-9") 
                    || feats.includes("alchemist-9")) { 
                attackDie = "d8";
            } else if(feats.includes("warrior-1") 
                    || feats.includes("expert-5") 
                    || feats.includes("thief-5") 
                    || feats.includes("bard-5") 
                    || feats.includes("alchemist-5")) { 
                attackDie = "d6";
            } else if(feats.includes("expert-1")) {
                attackDie = "d4"; 
            } else {
                attackDie = untrained;
            }
            setAttrs({ featlist: feats, powername: power, power_max: powerMax, attack: attackDie, attack_max: attacks, hitpoints_max: maxHP });
           
            // clear out the skills, to prepare for running through the tallied skill list
            var skillData = {};
            skills.forEach(skill => { skillData[skill] = untrained; skillData[skill+"_max"] = "d4"; });
            
            // first, work out skill maximums based on highest class and level skill caps
            
            if(feats.includes("warrior-2")) { // Superior Athlete gives warriors better physical saves
                skillData["athletics_max"]  = biggerDie(skillData["athletics_max"], attackDie);
                skillData["reflex_max"]     = biggerDie(skillData["reflex_max"], attackDie);
                skillData["fortitude_max"]  = biggerDie(skillData["fortitude_max"], attackDie);
            }
       
            var maxDie;
            if(feats.includes("expert-10")
            || feats.includes("wizard-9")
            || feats.includes("cleric-9")
            || feats.includes("druid-9")) { 
                maxDie = "d12"; // magic-users reach a d12 skill cap at level 9, while experts reach it at level 10
            } else if(feats.includes("expert-7")
            || feats.includes("wizard-7")
            || feats.includes("cleric-7")
            || feats.includes("druid-7")) { 
                maxDie = "d10"; // magic-users and experts both reach a d10 skill cap at level 7
            } else if(feats.includes("expert-4")
            || feats.includes("druid-5") 
            || feats.includes("wizard-5")
            || feats.includes("cleric-5")
            || feats.includes("warrior-9")) {
                maxDie = "d8"; // experts reach a d8 skill cap at level 4, while magic-users reach it at level 5, and warriors at level 9.
            } else if(feats.includes("expert-1") 
            || feats.includes("druid-3") 
            || feats.includes("wizard-3") 
            || feats.includes("cleric-3") 
            || feats.includes("warrior-3")) { 
                maxDie = "d6"; // experts start with a d6 skill cap, while magic-users reach it at level 3, and warriors else at level 5.
            } else {
                maxDie = "d4"; // magic-users and warriors start with a skill cap at d4.
            }

            console.log("  attack -> " + attackDie);
            
            // now run through the tallied skill list, and assign the appropriate skill levels
            skills.forEach(skill => { 
                // merge Superior Athlete limits into the normal skill limits
                skillData[skill+"_max"] = biggerDie(skillData[skill+"_max"], maxDie);
                
                // count number of times the skill appears in the tallied skill list
                let skillLevel = countMatches(skillList, skill);
                if(skillLevel > 0) { // once = d4. twice = d6, 3x = d8, 4x = d10, 5x or more = d12
                    if(skillLevel > 5) skillLevel = 5;
                    skillData[skill] = "d" + (skillLevel+1)*2;
                    
                    // respect the skill caps
                    if(biggerDie(skillData[skill], skillData[skill+"_max"]) == skillData[skill]) {
                      skillData[skill] = skillData[skill+"_max"];
                    }
                }
                
                // see if there are any pending choices for this skill
                let opt = "";
                if((skillOptions.includes(skill) || skillOptions.includes("any")) 
                && biggerDie(skillData[skill], skillData[skill+"_max"]) != skillData[skill]) {
                    opt = " - *can train"; 
                    // show the [+] training button next to this skill
                    $20(`button[name=act_train-${skill}]`).removeClass('hidden');
                } else { 
                    // hide the [+] training button next to this skill
                    $20(`button[name=act_train-${skill}]`).addClass('hidden'); 
                }
                console.log("  " + skill + " -> " + skillData[skill] + " (max " + skillData[skill+"_max"] + ")" + opt);
            });
            // set all the skills and skill caps at once
            setAttrs(skillData);
        });
    }
    
    function updatedv(save) {
      let dv = save+"-dv"; 
      let mod = save2mod(save);
      if(mod == "") {
          console.log("ERROR: " + save + " isn't a saving throw skill.");
          return;
      }
      console.log("updating " + save + "("+mod+")");
      getAttrs([save, mod], function(values) {
        if(values[save] == undefined || values[mod] == undefined) {
            console.log("--Uninitialized! Aborting...");
        }
        // a dv equals 10 + ability mod + half the proficiency die maximum
        let prof = values[save];
        let val = 10+1*values[mod];
        val += die2dv(prof);
        console.log("  " + save + " (" + prof + values[mod] + ") => " + dv + " (" + val + ")");
    	setAttrs({ [dv]: val });      
      });
    }

 function updatemod(ability) {
  console.log("updating " + ability ); 
  getAttrs([ability,"race_max"], function(values) {
    // most races provide two bonuses; 
    // racial bonuses are always a +1 to the mod
    // (racial bonuses never affect the raw score)
    let raceMods = values["race_max"];
    let score = values[ability];
    
    if(score == undefined || score == "roll") { 
      // if the score hasn't been set yet, then hail the dread lord Gygax and roll a flat 3d6
      score = rollAbility(ability);
      console.log("rolling " + ability + " (3d6): " + score);
      setAttrs({ [ability]: score });
    }
    // scores are always referred to by their full name, 
    // while mods are always referred to by their first 3 letters
    let modname = ability.substring(0,3);
    
    // we're using B/X ability modifiers, like a good little OSR demiclone
    let mod = a2mod(score);

    // if the race includes this mod in its bonuses, add +1 to the mod
    if(String(raceMods).toLowerCase().includes(String(modname).toLowerCase())) {
      mod++;
      if(mod >= 0) mod = "+" + mod; 
    }
    console.log("  " + ability + " (" + score + ") => " + modname + " (" + mod + ")");
    setAttrs({  
        [modname]: mod,
        [modname+'_max']: mod
        
    });

    if(String(modname).toLowerCase() == "con") {
        recalcHitPoints();
        recalcWounds();
    }
    // update the associated saving throw dv for this ability
    updatedv(mod2save(modname));
  });
 }
 
 function recalcHitPoints() {
    getAttrs(levelUpData, function(values) {
        if(values["l1feat"] == undefined) {
            console.log("UNINITIALIZED CHARACTER! Aborting validation.");
            return;
        }
        let level = values["level"];
        let hitDice = Math.floor(level/3+.667);
        console.log("level " + level + " " + values["class"] + " (" + hitDice + "hd)");
        // work out maximum HP for this class and level
        let hpBonus = die2dv(values["hd1"]) + 1.0*values["con"];
        if(hpBonus < 1) hpBonus = 1;
        let maxHP = Math.floor(0.5*values["constitution"]) + hpBonus * level;
        console.log("max hitpoints: " + maxHP);
        setAttrs({ hitpoints_max : maxHP });

    });
 }
 
 function recalcWounds() {
    getAttrs(["wounds", "fatigue", "str_max", "dex_max", "con_max", "int_max", "wis_max", "cha_max"], function(values) {
        let con = Math.floor(values["con_max"] * 1.0);
        let threshold = con > 0 ? con : 0;
        let hindrance = Math.floor(1.0*values["wounds"]) + Math.floor(1.0*values["fatigue"]);
        let penalty = (threshold > hindrance ? 0: hindrance - threshold);
        let modData = [];
        modData["wounds_max"] = con + 5;
        modData["fatigue_max"] = threshold;
        modData["condition_max"] = penalty;
        setAttrs(modData);
    });
 }
 
 function train(skill) {

    // each skill is either 0, or a die size between d4 and d12. 
    // training a skill means raising it by one die size,
    // if doing so wouldn't exceed that skill's cap.
    
    // (skill caps are determined by class and level - see
    //  the validate() function for the complete calculations.)
    getAttrs([skill,skill+"_max"], function(values) {
      let die = values[skill];
      let max = values[skill+"_max"];
      console.log("  " + skill + ": " + die + " (max "+max + ")");

      // easiest way to get the skill as a numeric comparator is to
      // use the dv calculator, which assigns 0 to "none", 2 to d4,
      // 3 to d6, 4 to d8, 5 to d10, and 6 to d12.
      let dv = die2dv(die);
      if(dv == 0) {
        die = "d4"; // the first jump is from "none" to d4
      } else if(dv < die2dv(max)) {
        dv++; // we're below the cap, so raise the skill by one level
        die = "d"+dv*2; // the die size is always twice the dv
      }

      // see if we've changed the die size
      if(die != values[skill]) {
        // now find the first matching choose(...) in the l#feat_max 
        // level-up list, and replace that choose(...) with the name
        // of the chosen skill. 
        getAttrs(levelUpData, function(values) {
          for(let level = 1; level <= values["level"]; level++) {
            let choices = values["l"+level+"feat_max"];
            if( choices.includes("choose(")
            && (choices.includes("any") || choices.includes(skill)) ) {
              // we found a match at this level, 
              // now let's replace the first  
              // matching choose(...) for this level    
              let splitArray = choices.split("choose(");
              // non-optional skill training will always 
              // come before any choose(...) options
              let skillList = splitArray[0]; 
              for(let i = 1; i < splitArray.length; i++) {
               if( splitArray[i].includes("any") || splitArray[i].includes(skill) ) { 
                  // this is our first match, so replace it
                  skillList += skill; 
                  // only replace the first matching choice that we find;
                  // this means adding back all the remaining choices.
                  for(i++; i < splitArray.length; i++) { 
                    if(skillList > "") skillList += ", ";
                    skillList += "choose(" + splitArray[i];  
                  }
                } else { 
                  // it's not a match, so add it back
                  if(skillList > "") skillList += ", ";
                  skillList += "choose(" + splitArray[i]; 
                }
              }
              // we've now made our replacement, so we don't need to continue
              // traipsing through the level list willy-nilly
              console.log("  " + skill + " => " + die + " (max "+max + ")");
              console.log("   (replaces level " + level + " choice: ["+values["l"+level+"feat_max"]+"] -> ["+skillList+"])");
              setAttrs({ [skill]: die, ["l"+level+"feat_max"]: skillList });
              validate();
              return; // only replace the first matching choice level that we find
            }
          }
        });
      }
    });
 }
 
 // converting dice to their corresponding dv bonuses
// lets us compare them numerically, and return
// whichever one is bigger.
 function biggerDie(a, b) {
    if(die2dv(a) >= die2dv(b)) return a;
    return b;
 }
 
// a die adds half its maximum roll size to its saving throw dv,
// or any other static bonus (such as maximum hit points).
 function die2dv(d) {
    if(d.length == 0 || d[0] != "d") return 0;
    return Math.floor(d.substring(1,3)*0.5);
 }
 
// B/X ability modifiers are superior to 
// those used by 3.5e/4e/5e/5.5e/Pathfinder,
// especially since we aren't using the d20
// for exploration skill tests.
 function a2mod(a) {
  if(a==3) return "-3";
  if(a<6) return "-2";
  if(a<9) return "-1";
  if(a==18) return "+3";
  if(a>15) return "+2";
  if(a>12) return "+1";
  return "+0";
 }
 
// which ability mod does this save use?
 function save2mod(save) {
    if(save == "athletics") return "str";
    if(save == "reflex") return "dex";
    if(save == "fortitude") return "con";
    if(save == "deduction") return "int";
    if(save == "perception") return "wis";
    if(save == "willpower") return "cha";
    return "";
 }
 
  function skill2mod(skill) {
    if(skill == "athletics") return "str";
    if(skill == "reflex" || skill == "stealth" || skill == "finesse" ) return "dex";
    if(skill == "fortitude") return "con";
    if(skill == "deduction" || skill == "arcana" || skill == "crafting" || skill == "lore" ) return "int";
    if(skill == "perception" || skill == "animal-ken" || skill == "nature" || skill == "medicine" ) return "wis";
    if(skill == "willpower" || skill == "charm" || skill == "wit" ) return "cha";
    return "";
 }

// which save uses this ability mod?
 function mod2save(mod) {
    if(mod == "str") return "athletics";
    if(mod == "dex") return "reflex";
    if(mod == "con") return "fortitude";
    if(mod == "int") return "deduction";
    if(mod == "wis") return "perception";
    if(mod == "cha") return "willpower";
    return "";
 }
 
 // which ability score is this mod from?
 function mod2score(mod) {
    if(mod == "str") return "strength";
    if(mod == "dex") return "dexterity";
    if(mod == "con") return "constitution";
    if(mod == "int") return "intelligence";
    if(mod == "wis") return "wisdom";
    if(mod == "cha") return "charisma";
    return "";
 }
 
//simple regexp tally for how many times
//one string shows up inside another.
//primarily used for the skill validator
 function countMatches(str, test) {
    let regex = new RegExp(test, "g"); 
    return (str.match(regex ) || []).length;
 }


// just roll a d6
 function rollD6() {
   return Math.floor(Math.random()*6+1);
 }
 
// 3d6, in order. 
// Contemplate this on the tree of woe.
 function rollAbility(ability) {
   return rollD6()+rollD6()+rollD6();
 }
 
 function rollSkill(skill) {
  let rawmod = skill2mod(skill); 
  let ability = mod2score(rawmod);  
  getAttrs([skill, ability, rawmod, "power", "featlist", "d20"], function(values) {
    let featlist = values["featlist"];
    let abilityScore = Math.floor(1.0*values[ability]);
    let proficiency = Math.floor(2.0*die2dv(values[skill]));
    let maxRoll = values[rawmod] + Math.floor(2 * proficiency);
    let d20 = values["d20"];
    if(d20 == undefined) {
      d20 = "";
      if(proficiency == 0) d20 = "2d20kl1";
    }
    let rollString = `&{template:skills} {{name=@{character_name} }} `;
    rollString    += `{{skill=${skill}}} {{modname=${rawmod}}} {{rawmod=@{${rawmod}}}} `;
    if(d20 > "") {
      rollString  += ` {{d20=[[ ${d20} ]]}} `;
      rollString  += ` {{cof=[[ ${rules_dv_levels} ]]}}`;
    } else {
      rollString  += ` {{cof=[[ ${rules_cof_levels} ]]}}`;
    }
    if(proficiency > 0) {
      rollString  += ` {{die=@{${skill}}}} {{roll=[[ @{${skill}} ]]}}`;
      if(featlist.includes("expert-3")) {
        rollString += ` {{score=@{${ability}}}} {{ability=[[ @{${ability}}}} ]]}} {{proficiency=[[ ${proficiency} ]]}}`
        rollString += ` {{talent=[[ 0 ]]}} {{total1a=[[ 0 ]]}} {{total1p=[[ 0 ]]}} {{total2=[[ 0 ]]}}`;
      }
    }
    rollString    += ` {{mod=[[ @{${rawmod}} ]]}}`;
    rollString    += ` {{total=[[ 0 ]]}}`;// {{effects=[[ 0 ]]}}`;
    console.log(rollString);
    
    startRoll(rollString, data => {
      const results = data.results;
      const mod = Math.floor(1.0*results.mod.result);
      const cof = results.cof.result;
      const roll = (results.roll == undefined) ? 0 : results.roll.result;
      const d20 = (results.d20 == undefined) ? 0 : results.d20.result;
      const rollResult = d20 + roll + mod;
      let talentResult = 0;
      let abilityResult = 0;
      let proficiencyResult = 0;
      let bothResult = 0;

      if(featlist.includes("expert-3")) {
        if( d20 > 1 && d20 < abilityScore) {
            abilityResult = abilityScore + roll + mod;
            talentResult++;
        }
        if( roll > 1 && roll < proficiency) {
            proficiencyResult = d20 + proficiency + mod; 
            talentResult++;
        }
        if(talentResult == 2) {
            bothResult = abilityScore + proficiency + mod;
        }
      }
      console.log(talentResult);
      finishRoll(data.rollId, {
        d20:     String.fromCharCode(64 + d20),  
        roll:    String.fromCharCode(64 + roll),  
        talent:  talentResult,
        total:   rollResult,
        total1a: abilityResult,
        total1p: proficiencyResult,
        total2:  bothResult
      });
      console.log(skill + " (" + values[skill] + "+" + mod + "): " + rollResult + " vs " + cof + "(" + results.cof.expression + ")");
    });
  });
 }
 
 function rollAttack(attacktype) {
  getAttrs(["attack", "featlist", "d20", "weapon1", "accuracy1", "damage1"], function(values) {
    let weapon = values["weapon1"];
    let accuracy = values["accuracy1"];  
    let damage = values["damage1"];
    let attack = values["attack"];  
    let d20 = values["d20"];
    if(d20 == undefined) d20 = "";

    let rollString = `&{template:attacks} {{name=@{character_name}}} {{title=${weapon}}} {{attacktype=${attacktype}}}`;
    rollString    += ` {{dmg=${damage}}} {{die=@{attack}}} {{accuracy=${accuracy}}} `
    if(attack = untrained) attack = 0;
    rollString    += ` {{roll=[[ @{attack} ]]}} {{d20=[[ ${d20} ]]}}`;
    rollString    += ` {{defense=[[ ?{vs Defense} ]]}}`;
    rollString    += ` {{total=[[ 0 ]]}} {{hit=[[ 0 ]]}}`;
    rollString    += ` {{damage=[[ ${damage} ]] }} {{bonusdmg=[[ 0 ]]}} {{effects=[[ 0 ]]}}`;
    console.log(rollString);
    
    startRoll(rollString, data => {
      const results = data.results;
      const roll = results.roll.result;
      const d20 = (results.d20 == undefined) ? 0 : results.d20.result;
      const defense = results.defense.result;

      let damageResult = (results.damage == undefined) ? 0 : results.damage.result;
      let bonusDamage = 0; 
      let rollResult = d20 + roll + 1*accuracy;
      let effectsResult = "";
      let hitResult = 0;
      if(roll ==1 && d20 == 1) {
          effectsResult = "Critical Miss";
          hitResult = -1;
      } else if(rollResult <= defense && d20 < 20) {
          effectsResult = "Miss";
          hitResult = 0;
      } else {
        if(roll >= 10 || (d20 >= 20 && roll > defense)) {
            effectsResult = "Critical Hit"; 
            hitResult = 2;
        } else {
            effectsResult = "Hit";
            hitResult = 1;
        }
        if(values["featlist"].includes("warrior-1")) {
          bonusDamage = roll;
          damageResult += roll;
          if(roll >= 6) {
              if(effectsResult > "") effectsResult += " + ";
              effectsResult += "Weapon Mastery effect";
          }
        }
      }
      finishRoll(data.rollId, {
        d20: String.fromCharCode(d20 + 64),  
        roll: String.fromCharCode(roll + 64),  
        total: rollResult,
        damage: damageResult,
        bonusdmg: bonusDamage,
        effects: effectsResult,
        hit: hitResult
      });
      console.log(weapon + " (" + attack + accuracy + "): " + rollResult);   
    });
  });
 }

 function rollDodge() {
    let rollString = `&{template:reactions} {{name=@{character_name} }} {{title=dodge}}`;
    rollString    += ` {{reflexdie=@{reflex}}} `;
    rollString    += ` {{defense=[[@{defense}]]}} {{reflex=[[@{reflex}]]}} {{mod=[[@{dex}]]}}`;
    rollString    += ` {{total=[[ 0 ]]}}`;
    console.log(rollString);
    
    startRoll(rollString, data => {
      const results = data.results;
      const rollResult = results.defense.result + results.reflex.result;
      let effectsResult = "";
      finishRoll(data.rollId, {
        reflex: String.fromCharCode(results.reflex.result + 64),  
        total: rollResult,
        effects: effectsResult
      });
      console.log(rollResult);   
    });
 }
 function rollParry() {
    let rollString = `&{template:reactions} {{name=@{character_name} }} {{title=parry}}`;
    rollString    += ` {{parrydie=@{attack}}} {{parrymod=@{parry2}}}`;
    rollString    += ` {{defense=[[@{defense}]]}} {{parry=[[@{attack}]]}} {{mod=[[@{parry2}]]}}`;
    rollString    += ` {{total=[[ 0 ]]}}`;
    console.log(rollString);
    
    startRoll(rollString, data => {
      const results = data.results;
      const rollResult = results.defense.result + results.parry.result + results.mod.result;
      finishRoll(data.rollId, {
        parry: String.fromCharCode(results.parry.result + 64),  
        total: rollResult
      });
      console.log(rollResult);   
    });
 }
 function rollDeflect() {
    let rollString = `&{template:reactions} {{name=@{character_name} }} {{title=deflect}}`;
    rollString    += ` {{reflexdie=@{reflex}}} {{parrydie=@{attack}}}`;
    rollString    += ` {{defense=[[@{defense}]]}} {{reflex=[[@{reflex}]]}} {{parry=[[@{attack}]]}} {{parrymod=}}`;
    rollString    += ` {{total=[[ 0 ]]}} {{effects=[[ 0 ]]}}`;
    console.log(rollString);
    
    startRoll(rollString, data => {
      const results = data.results;
      const rollResult = results.defense.result + results.reflex.result + results.parry.result;
      const higher = (results.reflex.result > results.parry.result ? results.reflex.result : results.parry.result);
      let effectsResult = "Reduce damage by " + higher; 
      finishRoll(data.rollId, {
        reflex: String.fromCharCode(results.reflex.result + 64),  
        parry: String.fromCharCode(results.parry.result + 64),  
        total: rollResult,
        effects: effectsResult
      });
      console.log(rollResult);   
    });
 }
 

    

</script>

<!-- roll template -->

<rolltemplate class="sheet-rolltemplate-rolls">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
    </div>
    <div class="sheet-content">
      {{#roll}}<div class="sheet-value sheet-fullwidth"><span class="sheet-big">{{roll}}</span></div>{{/roll}}
      {{#allprops() title name roll desc}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title name roll desc}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-skills">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#skill}}<div class="sheet-title" data-i18n-dynamic>{{skill}}</div>{{/skill}}
    </div>
    <div class="sheet-content">
      <div class="sheet-value sheet-fullwidth">
          {{#d20}}<span class="sheet-d20">{{computed::d20}}</span>{{#die}} + {{/die}}{{/d20}}
          {{#die}}<span class="sheet-{{die}}">{{computed::roll}}</span>{{/die}} {{rawmod}} = 
          {{#cof}}
          {{#rollGreater() computed::total cof}}<span class="sheet-big sheet-notip sheet-green">{{/rollGreater() computed::total cof}}
          {{#^rollGreater() computed::total cof}}<span class="sheet-big sheet-notip sheet-red">{{/^rollGreater() computed::total cof}}
          {{/cof}}
          {{#^cof}}<span class="sheet-big sheet-notip">{{/^cof}}{{computed::total}}</span>
      </div>
    {{#rollGreater() computed::talent 0}}
      <div class="sheet-value sheet-fullwidth">
          <!-- [Use Reliable Talent](`#skillroll #var name={{name}}}} #var skill={{skill}}}} #var rawmod={{rawmod}}}} #var d20=[[{{ability}}]]}} #var die={{die}}}} #var roll=[[{{roll}}]]}} #var total=[[{{ability}}+{{roll}}{{rawmod}}]]}}) -->
          <i>With Reliable Talent:</i>
      {{#rollGreater() computed::total1a total}} 
      </div><div class="sheet-key">
          <span class="sheet-black sheet-small">{{ability}}</span> + 
          <span class="sheet-{{die}} sheet-smalldice">{{computed::roll}}</span> {{rawmod}} = 
      </div><div class="sheet-value">
          {{#cof}}
          {{#rollGreater() computed::total1a cof}}<span class="sheet-notip sheet-green sheet-small">{{/rollGreater() computed::total1a cof}}
          {{#^rollGreater() computed::total1a cof}}<span class="sheet-notip sheet-red sheet-small">{{/^rollGreater() computed::total1a cof}}
          {{/cof}}
          {{#^cof}}<span class="sheet-notip sheet-smalldice">{{/^cof}}{{computed::total1a}}</span> (x1)
        {{/rollGreater() computed::total1a total}}
        {{#rollGreater() computed::total1p total}}
      </div><div class="sheet-key">
          {{#d20}}<span class="sheet-d20 sheet-smalldice">{{computed::d20}}</span>{{#die}} + {{/die}}{{/d20}}
          <span class="sheet-black sheet-small">{{proficiency}}</span> {{rawmod}} = 
      </div><div class="sheet-value">
          {{#cof}}
          {{#rollGreater() computed::total1p cof}}<span class="sheet-notip sheet-green sheet-small">{{/rollGreater() computed::total1p cof}}
          {{#^rollGreater() computed::total1p cof}}<span class="sheet-notip sheet-red sheet-small">{{/^rollGreater() computed::total1p cof}}
          {{/cof}}
          {{#^cof}}<span class="sheet-notip sheet-small">{{/^cof}}{{computed::total1p}}</span> (x1)
        {{/rollGreater() computed::total1p total}}
        {{#rollGreater() computed::total2 total}}
      </div><div class="sheet-key">
          <span class="sheet-black sheet-small">{{ability}}</span> + 
          <span class="sheet-black sheet-small">{{proficiency}}</span> {{rawmod}} = 
      </div><div class="sheet-value">
          {{#cof}}
          {{#rollGreater() computed::total2 cof}}<span class="sheet-notip sheet-green sheet-small">{{/rollGreater() computed::total2 cof}}
          {{#^rollGreater() computed::total2 cof}}<span class="sheet-notip sheet-red sheet-small">{{/^rollGreater() computed::total2 cof}}
          {{/cof}}
          {{#^cof}}<span class="sheet-notip sheet-small">{{/^cof}}{{computed::total2}}</span> (x2)
        {{/rollGreater() computed::total2 total}}
      </div>
    {{/rollGreater() computed::talent 0}}
    </div>
    {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-saves">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#skill}}<div class="sheet-title" data-i18n-dynamic>{{skill}}</div>{{/skill}}
    </div>
    <div class="sheet-content">
      <div class="sheet-value sheet-fullwidth">
          {{#d20}}
          <span class="sheet-d20">^{ d20.{{d20}} }</span>
          {{#die}} + {{/die}}{{/d20}}
          {{#die}}<span class="sheet-{{die}}">{{roll}}</span>{{/die}} {{rawmod}} = 
          {{#cof}}
          {{#rollGreater() computed::total cof}}<span class="sheet-big sheet-notip sheet-green">{{/rollGreater() computed::total cof}}
          {{#^rollGreater() computed::total cof}}<span class="sheet-big sheet-notip sheet-red">{{/^rollGreater() computed::total cof}}
          {{/cof}}
          {{#^cof}}<span class="sheet-big sheet-notip">{{/^cof}}{{computed::total}}</span>
      </div>
    </div>
    {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-reactions">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#title}}<div class="sheet-title" data-i18n-dynamic>{{title}}</div>{{/title}}
    </div>
    <div class="sheet-content">
      <div class="sheet-value sheet-fullwidth">
          <span class="sheet-dv-med sheet-notip">{{defense}}</span>
          {{#reflex}}+<span class="sheet-{{reflexdie}}">{{computed::reflex}}</span>{{/reflex}}
          {{#parry}}+<span class="sheet-{{parrydie}}">{{computed::parry}}</span>{{parrymod}}{{/parry}}
          = <span class="sheet-dv-big sheet-notip">{{computed::total}}</span>
      </div>
    </div>
      {{#effects}}<div class="sheet-info sheet-notip">{{computed::effects}}</div>{{/effects}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-attacks">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
    </div>
    
    <div class="sheet-content">
      <div class="sheet-value sheet-fullwidth">
          <span class="sheet-d20">{{computed::d20}}</span>{{#die}} + <span class="sheet-{{die}}">{{computed::roll}}</span>{{/die}} {{accuracy}}
      </div>
      <div class="sheet-value sheet-fullwidth"><span class="sheet-big sheet-notip">{{computed::total}}</span> vs <span class="sheet-dv-big sheet-notip">{{defense}}</span></div>
    </div>
    <div class="sheet-info sheet-notip">{{computed::effects}}</div>
    {{#rollGreater() computed::hit 0}} 
    <div class="sheet-content">
      <div class="sheet-key">Damage ({{#rollGreater() computed::bonusdmg 0}}<span class="sheet-{{die}} smalldice">{{computed::roll}}</span>+{{/rollGreater() computed::bonusdmg 0}}{{dmg}}):</div>
      <div class="sheet-value">{{computed::damage}}</div>
    </div>
    {{/rollGreater() computed::hit 0}} 

    {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
  </div>
</rolltemplate>
