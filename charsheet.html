<main>
  <section class="header">
    <div class="f-row">
      <label class="header-label" data-i18n="name">Name:</label>
      <span><input name="attr_character_name" class="character-name"></span>
    </div>
    <div class="f-row nowrap">
      <label class="header-label" data-i18n="race">Race:</label>
      <span><select name="attr_race" class="character-race">
          <option data-i18n="human" value="human">Human</option>
          <option data-i18n="dwarf" value="dwarf">Dwarf</option>
          <option data-i18n="elf" value="elf">Elf</option>
          <option data-i18n="halfling" value="halfling">Halfling</option>
          <option data-i18n="goblin" value="goblin">Goblin</option>
          <option data-i18n="lizardfolk" value="lizardfolk">Lizardfolk</option>
          <option data-i18n="hen-ge" value="hen-ge">Hen-ge</option>
          <option data-i18n="satyr" value="satyr">Satyr</option>
          <option data-i18n="centaur" value="centaur">Centaur</option>
          <option data-i18n="genasi" value="genasi">Genasi</option>
      </select></span>
      <label class="header-label" data-i18n="bonuses">Bonuses:</label>
      <span><input name="attr_race_max" class="character-race"></span>
    </div>
  </section>

  <section class="builder">
  </section>
  
  <section class="level f-row nowrap">
    <span>
      <input type="hidden" name="attr_level" class="character-level" >
      <select name="attr_class" class="character-class">
        <option data-i18n="knight" value="knight">Knight</option>
        <option data-i18n="martial-artist" value="martial-artist">Martial Artist</option>
        <option data-i18n="berserker" value="berserker">Berserker</option>
        <option data-i18n="thief" value="thief">Thief</option>
        <option data-i18n="alchemist" value="alchemist">Alchemist</option>
        <option data-i18n="bard" value="bard">Bard</option>
        <option data-i18n="wizard" value="wizard">Wizard</option>
        <option data-i18n="cleric" value="cleric">Cleric</option>
        <option data-i18n="druid" value="druid">Druid</option>
      </select>
      <span class="character-class" name="attr_class" data-i18n-dynamic></span>
    </span>
    <span>
      <select name="attr_level" class="character-level">
          <option value="0">&#x1F513;</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
      </select>
    </span>
  </section>

  <section class="actions f-col nowrap">
   <input type="hidden" name="attr_power_max" class="power-max" >
   <div class="f-row nowrap show-power">
      <label class="ability"><span name="attr_powername" data-i18n-dynamic ></span></label>
      <span class="blockbox">
        <input class="bigbox" name="attr_power">
        <span style="font-size: 18px; font-style: bold;"><b>/</b></span>
        <input class="bigbox" readonly name="attr_power_max"></span>
   </div>    
   <input type="hidden" name="attr_situation" class="situation-toggle">
   <div class="situationPanel">
   <div class="panelHeader">
    <button class="tab-travel" type="action" name="act_travel"><span data-i18n="tab-travel">Travel</span></button>
    <button class="tab-explore" type="action" name="act_explore"><span data-i18n="tab-explore">Explore</span></button>
    <button class="tab-fight" type="action" name="act_fight"><span data-i18n="tab-fight">Fight</span></button>
    <button class="tab-journal" type="action" name="act_journal"><span data-i18n="tab-journal">Journal</span></button>
   </div>  
   <div class="panel-explore">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_skill"><span data-i18n="interact">Interact</span></button>
      </span>
      <label class="description">Describe what action your character performs, then roll the skill that the referee asks for.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_watch"><span data-i18n="watch">Watch</span></button>
      </span>
      <label class="description">Keeping Watch helps keep the party safe from ambushes.</label>
    </div> 
    <hr class="line">
    <div class="f-row">
      <span>
        <button class="action" type="action" name="act_rest"><span data-i18n="rest">Rest</span></button>
      </span>
      <label class="description" data-i18n="rest-description">Resting spends one <b>hit die</b> to heal hit points and recover all <span name="attr_powername"></span>.<br>
      </label>
    </div> 
    <input type="hidden" name="attr_level" class="character-level" >
    <div class="f-row f-center">
      <span class="rollbox">
        <button class="proficiency" type="roll" name="roll_hd1" 
          value="&{template:rolls} {{subtitle=Hit Die (@{hd1}@{con})}} {{title=@{character_name} }} {{roll= [[{1d1,@{hd1}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd1" data-i18n-dynamic></span></label>
      </span>
      &nbsp;
      <span class="rollbox show-l4">
        <button class="proficiency req-l4" type="roll" name="roll_hd2" 
          value="&{template:rolls} {{subtitle=Hit Die (@{hd2}@{con})}} {{title=@{character_name} }} {{roll= [[{1d1,@{hd2}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd2" data-i18n-dynamic></span></label>
      </span>
      &nbsp;
      <span class="rollbox show-l7">
        <button class="proficiency req-l7" type="roll" name="roll_hd3" 
          value="&{template:rolls} {{subtitle=Hit Die (@{hd3}@{con})}} {{title=@{character_name} }} {{roll= [[{1d1,@{hd3}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd3" data-i18n-dynamic></span></label>
      </span>
      &nbsp;
      <span class="rollbox show-l10">
        <button class="proficiency req-l10" type="roll" name="roll_hd4" 
          value="&{template:rolls} {{subtitle=Hit Die (@{hd4}@{con})}} {{title=@{character_name} }} {{roll= [[{1d1,@{hd4}@{con}}kh1[hit points] ]]}}">
        </button><label class="proficiency-die"><span name="attr_hd4" data-i18n-dynamic></span></label>
      </span>
    </div>
   </div panel-explore>
 
   <div class="panel-fight">
    <div class="f-row nowrap">
      <label class="initiative" data-i18n="initiative">Initiative</label>
      <button class="proficiency" type="roll" name="roll_initiative" 
       value="&{template:rolls} {{subtitle=Initiative}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{perception}[perception] ]]}}">
      </button><input name="attr_initiative" class="proficiency-die">
    </div>
    <div class="f-row nowrap">
      <label class="armor-defense" data-i18n="defense">Defense</label>
      <input name="attr_armor" type="text" class="armor">      
      <label class="dv-big"><span name="attr_defense"></span></label>
    </div>
    <div class="f-row nowrap">
      <label class="action" data-i18n="last-action">Last Action:</label>
      <label class="action"><span="attr_lastaction"></span></label>
    </div>
    <input type="hidden" name="attr_actiontab" class="action-toggle">
    <div class="actionPanel">
      <div class="panelHeader">
          <button class="tab-attack" type="action" name="act_attack"><span data-i18n="tab-attack">Attack</span></button>
          <button class="tab-defend" type="action" name="act_defend"><span data-i18n="tab-defend">Defend</span></button>
          <button class="tab-move" type="action" name="act_move"><span data-i18n="tab-move">Move</span></button>
          <button class="tab-react" type="action" name="act_react"><span data-i18n="tab-react">React</span></button>
          <button class="tab-feat" type="action" name="act_feat"><span data-i18n="tab-feat">Feats</span></button>
      </div>    
      <div class="panel-attack">
        <hr class="space">
        <div class="f-row nowrap">
          <label class="attacks"><span data-i18n="weapon-attacks">Weapon Attacks</span> (<span name="attr_attack_max"></span><span data-i18n="per-action">/action</span>)</label>
        <span class="rollbox">
            <button class="proficiency attack" type="roll" name="roll_attack" value="@{activeweapon}">
            </button><label class="proficiency-die"><span name="attr_attack" data-i18n-dynamic></span></label>
        </span>
        </div>
        <hr class="line">
        <div>
          <div class="f-row nowrap">
            <input name="attr_activeweapon" type="radio" value="@{attack1_action}">
            <input name="attr_weapon1" class="weapon">
            <input name="attr_accuracy1" class="weapon-accuracy">
          </div>
          <hr class="space">
          <div class="f-row nowrap">
              <label class="damage" data-i18n="damage">Damage:</label><input name="attr_damage1" class="damage"><button class="damage" type="roll" name="roll_damage1" 
    	         value="&{template:rolls} {{subtitle=Damage: @{weapon1}}} {{title=@{character_name} }} {{roll= [[@{damage1}[damage] ]]}}">
              </button>
          </div>
        </div>
        <hr class="line">
        <div>
          <div class="f-row nowrap">
            <input name="attr_activeweapon" type="radio" value="@{attack2_action}">
            <input name="attr_weapon2" class="weapon">
            <input name="attr_accuracy2" class="weapon-accuracy">
          </div>
          <hr class="space">
          <div class="f-row nowrap">
              <label class="damage" data-i18n="damage">Damage:</label><input name="attr_damage2" class="damage"><button class="damage" type="roll" name="roll_damage2" 
  	           value="&{template:rolls} {{subtitle=Damage: @{weapon2}}} {{title=@{character_name} }} {{roll= [[@{damage2}[damage] ]]}}">
              </button>
          </div>
        </div>
      </div panel-attack>
      
      <div class="panel-move">
        <hr class="space">
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_walk"><span data-i18n="walk">Walk</span></button>
            <label class="action"><span name="attr_speed"></span> <span data-i18n="paces">paces</span> / <span data-i18n="round">round</span></label>
        </div>
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_sprint"><span data-i18n="sprint">Sprint</span></button>
            <label class="action"><span name="attr_sprintspeed"></span> <span data-i18n="paces">paces</span> / <span data-i18n="round">round</span></label>
        </div>
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_jump"><span data-i18n="jump">Jump</span></button>
            <label class="action"><span name="attr_jumpspeed"></span> <span data-i18n="paces">paces</span></label>
        </div>
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_climb"><span data-i18n="climb">Climb</span></button>
            <label class="action"><span name="attr_climbspeed"></span> <span data-i18n="paces">paces</span> / <span data-i18n="round">round</span></label>
        </div>
        <div class="f-row nowrap">
            <button type="action" class="action" name="act_swim"><span data-i18n="swim">Swim</span></button>
            <label class="action"><span name="attr_swimspeed"></span> <span data-i18n="paces">paces</span> / <span data-i18n="round">round</span></label>
        </div>
      </div panel-move>
      
      <div class="panel-defend">
        <hr class="space">
        <div class="f-row">
            <button type="action" class="action" name="act_guard"><span data-i18n="guard">Guard</span></button>
            <label class="description" data-i18n="guard-description">Regain your reaction after you successfully parry or hit with an opportunity attack</label>
        </div>
        <hr class="line">
        <div class="f-row">
            <button type="action" class="action" name="act_evade"><span data-i18n="evade">Evade</span></button>
            <label class="description" data-i18n="evade-description">Regain your reaction after you successfully dodge</label>
        </div>
        <hr class="line">
        <div class="f-row">
            <button type="action" class="action" name="act_hide"><span data-i18n="hide">Hide</span></button>
            <label class="description" data-i18n="hide-description">Roll Stealth to become hidden</label>
        </div>
      </div panel-defend>
      
      <div class="panel-react">
        <hr class="space">
        <div class="f-row">
          <span><button class="opportunity-attack" type="roll" name="roll_opattack" value="@{activeweapon}"></button></span>
          <label class="description"><b><span data-i18n="opportunity-attack">Opportunity Attack</span></b><br>
          <span data-i18n="opportunity-attack-description">Attack with your current weapon.</span></label>
        </div> 
        <hr class="line">
        <div class="f-row">
          <span><button class="defend" type="roll" name="roll_dodge" 
   	        value="&{template:rolls} {{subtitle=Dodge}} {{title=@{character_name} }} {{roll= [[@{defense}+@{reflex}[dodge] ]]}}"></button></span>
          <label class="description"><b><span data-i18n="dodge">Dodge</span></b><br>
          <span data-i18n="dodge-description" data-i18n-vars="<span name='attr_reflex'></span>">Add <b><span name="attr_reflex"></span></b> to your Defense vs one attack.</span></label>
        </div> 
        <hr class="line">
        <div class="f-row">
          <span><button class="defend" type="roll" name="roll_parry" 
   	        value="&{template:rolls} {{subtitle=Parry (@{weapon2})}} {{title=@{character_name} }} {{roll=[[@{defense}+@{parry2}+@{attack}[parry] ]]}}"></button></span>
          <label class="description"><b><span data-i18n="parry">Parry</span> (<span name="attr_weapon2"></span>)</b><br>
          <span data-i18n="parry-description" data-i18n-vars="<span name='attr_attack'></span>|<span name='attr_parry2'></span>">Add <b><span name="attr_attack"></span><span name="attr_parry2"></span></b>
          to your Defense vs one melee attack (or vs one ranged attack if you are using a shield).</span></label>
        </div> 
      </div panel-react>
      
    </div actionPanel>
   </div panel-fight>
   
   <div class="panel-journal">
   </div panel-journal>
  </div situationPanel>
  </section>


  <section class="str f-col nowrap">
    <div class="f-row nowrap">
      <!--input name="attr_strength" class="ability" type="number"-->
      <!-- select name="attr_strength" class="ability-score">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select -->      
      <div class="ability-score"><span name="attr_strength"></span></div>
      <label class="ability" data-i18n="strength">Strength</label>
      <div class="ability-mod"><span name="attr_str"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-athletics">+</button>
      </span><span  data-i18n="athletics">Athletics</span></label>
      <label class="dv"><span name="attr_athletics-dv"></span></label> 
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_athletics" 
	      value="&{template:rolls} {{subtitle=Athletics}} {{title=@{character_name} }} {{roll= [[@{d20}@{str}+@{athletics}[athletics] ]]}}">
        </button><label class="proficiency-die"><span name="attr_athletics" data-i18n-dynamic></span></label>
      </span>
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="ability" data-i18n="encumbrance">Encumbrance</label>
      <span name="attr_encumbrance" class="bigbox"></span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="action"><span name="attr_movement"></span> <span  data-i18n="speed">Speed</span></label>
      <span name="attr_move" class="bigbox"></span>
    </div>
  </section>

  <section class="dex f-col nowrap">
    <div class="f-row nowrap">
      <!-- select name="attr_dexterity" class="ability-score">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select -->      
      <div class="ability-score"><span name="attr_dexterity"></span></div>
      <label class="ability" data-i18n="dexterity">Dexterity</label>
      <div class="ability-mod"><span name="attr_dex"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-reflex">+</button>
      </span><span  data-i18n="reflex">Reflex</span></label>
      <label class="dv"><span name="attr_reflex-dv"></span></label> 
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_reflex" 
	      value="&{template:rolls} {{subtitle=Reflex}} {{title=@{character_name} }} {{roll= [[@{d20}@{dex}+@{reflex}[reflex] ]]}}">
        </button><label class="proficiency-die"><span name="attr_reflex" data-i18n-dynamic></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-stealth">+</button>
      </span><span  data-i18n="stealth">Stealth</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_stealth" 
	      value="&{template:rolls} {{subtitle=Stealth}} {{title=@{character_name} }} {{roll= [[@{d20}@{dex}+@{stealth}[stealth] ]]}}">
        </button><label class="proficiency-die"><span name="attr_stealth" data-i18n-dynamic></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-finesse">+</button>
      </span><span  data-i18n="finesse">Finesse</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_finesse" 
      	  value="&{template:rolls} {{subtitle=Finesse}} {{title=@{character_name} }} {{roll= [[@{d20}@{dex}+@{finesse}[finesse] ]]}}">
        </button><label class="proficiency-die"><span name="attr_finesse" data-i18n-dynamic></span></label>
      </span>
    </div>
  </section>

  <section class="con f-col nowrap">
    <div class="f-row nowrap">
      <!-- select name="attr_constitution" class="ability-score">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select -->      
      <div class="ability-score"><span name="attr_constitution"></span></div>
      <label class="ability" data-i18n="constitution">Constitution</label>
      <div class="ability-mod"><span name="attr_con"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-fortitude">+</button>
      </span><span  data-i18n="fortitude">Fortitude</span></label>
      <label class="dv"><span name="attr_fortitude-dv"></span></label> 
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_fortitude" 
	      value="&{template:rolls} {{subtitle=Fortitude}} {{title=@{character_name} }} {{roll= [[@{d20}@{con}+@{fortitude}[fortitude] ]]}}">
        </button><label class="proficiency-die"><span name="attr_fortitude" data-i18n-dynamic></span></label>
      </span>    
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="action nowrap"><span data-i18n="hit-points">Hit Points</span>:</label>
      <label class="action nowrap f-right"><input name="attr_temp-hitpoints" class="hp alt">+<input name="attr_hitpoints" class="hp">/<input name="attr_hitpoints_max" readonly class="hp"></label>      
    </div>
    <div class="f-row nowrap">
      <label class="action nowrap"><span data-i18n="fatigue">Fatigue</span>+<span data-i18n="wounds">Wounds</span>:</label>
      <label class="action nowrap f-right"><input name="attr_fatigue" class="wounds alt">+<input name="attr_wounds" class="wounds"></label>      
    </div>
  </section>

  <section class="int f-col nowrap">
    <div class="f-row nowrap">
      <!-- select name="attr_intelligence" class="ability-score">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select -->      
      <div class="ability-score"><span name="attr_intelligence"></span></div>
      <label class="ability" data-i18n="intelligence">Intelligence</label>
      <div class="ability-mod"><span name="attr_int"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-deduction">+</button>
      </span><span data-i18n="deduction">Deduction</span></label>
      <label class="dv"><span name="attr_deduction-dv"></span></label> 
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_deduction" 
	      value="&{template:rolls} {{subtitle=Deduction}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{deduction}[deduction] ]]}}">
        </button><label class="proficiency-die"><span name="attr_deduction" data-i18n-dynamic></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-arcana">+</button>
      </span><span data-i18n="arcana">Arcana</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_arcana" 
	      value="&{template:rolls} {{subtitle=Arcana}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{arcana}[arcana] ]]}}">
        </button><label class="proficiency-die"><span name="attr_arcana" data-i18n-dynamic></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-crafting">+</button>
      </span><span data-i18n="crafting">Crafting</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_crafting" 
	      value="&{template:rolls} {{subtitle=Crafting}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{crafting}[crafting] ]]}}">
        </button><label class="proficiency-die"><span name="attr_crafting" data-i18n-dynamic></span></label>
      </span>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill skill lore" name="act_train-lore">+</button>
      </span><span data-i18n="lore">Lore</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_lore" 
	      value="&{template:rolls} {{subtitle=Lore}} {{title=@{character_name} }} {{roll= [[@{d20}@{int}+@{lore}[lore] ]]}}">
        </button><label class="proficiency-die"><span name="attr_lore" data-i18n-dynamic></span></label>
      </span>
    </div>
  </section>

  <section class="wis f-col nowrap">
    <div class="f-row nowrap">
      <!-- select name="attr_wisdom" class="ability-score">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select -->      
      <div class="ability-score"><span name="attr_wisdom"></span></div>
      <label class="ability" data-i18n="wisdom">Wisdom</label>
      <div class="ability-mod"><span name="attr_wis"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-perception">+</button>
      </span><span data-i18n="perception">Perception</span></label>
      <label class="dv"><span name="attr_perception-dv"></span></label> 
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_perception" 
	      value="&{template:rolls} {{subtitle=Perception}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{perception}[perception] ]]}}">
        </button><label class="proficiency-die"><span name="attr_perception" data-i18n-dynamic></span></label>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill skill" name="act_train-animal-ken">+</button>
      </span><span data-i18n="animal-handling">Animal Ken</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_animal-ken" 
	      value="&{template:rolls} {{subtitle=Animal Ken}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{animal-ken}[animal-ken] ]]}}">
        </button><label class="proficiency-die"><span name="attr_animal-ken" data-i18n-dynamic></span></label>
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-nature">+</button>
      </span><span data-i18n="nature">Nature</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_nature" 
	      value="&{template:rolls} {{subtitle=Nature}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{nature}[nature] ]]}}">
        </button><label class="proficiency-die"><span name="attr_nature" data-i18n-dynamic></span></label>
      </span>    
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-medicine">+</button>
      </span><span data-i18n="medicine">Medicine</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_medicine" 
	      value="&{template:rolls} {{subtitle=Medicine}} {{title=@{character_name} }} {{roll= [[@{d20}@{wis}+@{medicine}[medicine] ]]}}">
        </button><label class="proficiency-die"><span name="attr_medicine" data-i18n-dynamic></span></label>
      </span>    
    </div>
  </section>

  <section class="cha f-col nowrap">
    <div class="f-row nowrap">
      <!-- select name="attr_charisma" class="ability-score">
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
      </select -->      
      <div class="ability-score"><span name="attr_charisma"></span></div>
      <label class="ability" data-i18n="charisma">Charisma</label>
      <div class="ability-mod"><span name="attr_cha"></span></div> 
    </div>
    <hr class="line">
    <div class="f-row nowrap">
      <label class="save"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-willpower">+</button>
      </span><span data-i18n="willpower">Willpower</span></label>
      <label class="dv"><span name="attr_willpower-dv"></span></label> 
      <span class="rollbox">
        <button class="proficiency save" type="roll" name="roll_willpower" 
	      value="&{template:rolls} {{subtitle=Willpower}} {{title=@{character_name} }} {{roll= [[@{d20}@{cha}+@{willpower}[willpower] ]]}}">
        </button><label class="proficiency-die"><span name="attr_willpower" data-i18n-dynamic></span></label>
      </span>    
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-charm">+</button>
      </span><span data-i18n="charm">Charm</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_charm" 
	      value="&{template:rolls} {{subtitle=Charm}} {{title=@{character_name} }} {{roll= [[@{d20}@{cha}+@{charm}[charm] ]]}}">
        </button><label class="proficiency-die"><span name="attr_charm" data-i18n-dynamic></span></label>
      </span>    
    </div>
    <hr class="space">
    <div class="f-row nowrap">
      <label class="skill"><span class="skill-trainingbox">
        <button type="action" class="train-skill" name="act_train-wit">+</button>
      </span><span data-i18n="wit">Wit</span></label>
      <span class="rollbox">
        <button class="proficiency skill" type="roll" name="roll_wit" 
	      value="&{template:rolls} {{subtitle=Wit}} {{title=@{character_name} }} {{roll= [[@{d20}@{cha}+@{wit}[wit] ]]}}">
        </button><label class="proficiency-die"><span name="attr_wit" data-i18n-dynamic></span></label>
      </span>    
    </div>

  </section>

  <section class="feats f-col">
    <h3><span data-i18n="class-features">Class Features</span></h3>
    <input type="hidden" name="attr_featlist" class="character-featlist">  
    <input type="hidden" name="attr_level" class="character-level" >
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;1</label>
      <span class="flush"><label class="list-first"><span name="attr_l1feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;2</label>
      <span class="flush"><label class="list-middle req-l2"><span name="attr_l2feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;3</label>
      <span class="flush"><label class="list-middle req-l3"><span name="attr_l3feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;4</label>
      <span class="flush"><label class="list-middle req-l4"><span name="attr_l4feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;5</label>
      <span class="flush"><label class="list-middle req-l5"><span name="attr_l5feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;6</label>
      <span class="flush"><label class="list-middle req-l6"><span name="attr_l6feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;7</label>
      <span class="flush"><label class="list-middle req-l7"><span name="attr_l7feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;8</label>
      <span class="flush"><label class="list-middle req-l8"><span name="attr_l8feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">&nbsp;9</label>
      <span class="flush"><label class="list-middle req-l9"><span name="attr_l9feat" data-i18n-dynamic></span></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="ability flush">10</label>
      <span class="flush"><label class="list-last req-l10"><span name="attr_l10feat" data-i18n-dynamic></span></span>
    </div>
  </section>

  <section class="equipment">
    <h3><span data-i18n="equipment">Equipment</span></h3>
    <div class="f-row nowrap flush">
      <label class="action flush" data-i18n="armor">Armor</label>
      <span class="flush"><input name="attr_eqarmor" class="list-first"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush" data-i18n="r-hand">R Hand</label>
      <span class="flush"><input name="attr_eqhand1" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush" data-i18n="l-hand">L Hand</label>
      <span class="flush"><input name="attr_eqhand2" class="list-last"></span>
    </div>
    <hr class="line">
    <div class="f-row nowrap flush">
      <label class="action flush" data-i18n="crown">Crown</label>
      <span class="flush"><input name="attr_eqcrown" class="list-first"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush" data-i18n="amulet">Amulet</label>
      <span class="flush"><input name="attr_eqamulet" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush"><span data-i18n="ring">Ring</span> <span style="font-size: 67%;">(R)</span></label>
      <span class="flush"><input name="attr_eqring1" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush"><span data-i18n="ring">Ring</span> <span style="font-size: 67%;">(L)</span></label>
      <span class="flush"><input name="attr_eqring2" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush" data-i18n="belt">Belt</label>
      <span class="flush"><input name="attr_eqbelt" class="list-middle"></span>
    </div>
    <div class="f-row nowrap flush">
      <label class="action flush" data-i18n="boots">Boots</label>
      <span class="flush"><input name="attr_eqboots" class="list-last"></span>
    </div>
  </section>

  <section class="inventory">
    <h3><span data-i18n="inventory">Inventory</span></h3>
    <textarea name="attr_inventory" class="inventory"></textarea>
  </section>

  <footer class="f-col f-center">
    <span style="font-color: white;" data-i18n="copyright">(C) Bakagaijin Productions</span>
  </footer>
</main>

<!-- roll template -->

<rolltemplate class="sheet-rolltemplate-rolls">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
    </div>
    <div class="sheet-content">
      {{#subtitle}}<div class="sheet-key">{{subtitle}}</div>{{/subtitle}}
      {{#roll}}<div class="sheet-value">{{roll}}</div>{{/roll}}
      {{#allprops() title name subtitle roll desc}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title name subtitle roll desc}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-saves">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
    </div>
    <div class="sheet-content">
      {{#subtitle}}<div class="sheet-key">{{subtitle}}</div>{{/subtitle}}
      {{#roll}}<div class="sheet-value">{{roll}}</div>{{/roll}}
      {{#allprops() title name subtitle desc}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title name subtitle desc}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-attacks">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
      {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
    </div>
    <div class="sheet-content">
      {{#hit}}
      <div class="sheet-key">Attack</div>
      <div class="sheet-value">{{hit}}</div>
      {{/hit}}
      {{#damage}}
      <div class="sheet-key">Damage</div>
      <div class="sheet-value">{{damage}}</div>
      {{/damage}}
      {{#allprops() title name subtitle desc attack hit damage}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title name subtitle desc attack hit damage}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>
</rolltemplate>

<!-- javascript -->
<script type="text/worker">

/*===== tabbed functionality =====*/
    const situationTabs = ["travel", "explore", "fight", "journal"];
    situationTabs.forEach(tab => {
        on(`clicked:${tab}`, function() {
            console.log("  clicked " + tab);
            setAttrs({ situation: tab });
            let mode = "";
            if(tab == "fight") mode = "d20";
            setAttrs({ d20: mode });
        });
    });

    const actionTabs = ["attack", "move", "defend", "react", "feat"];
    actionTabs.forEach(tab => {
        on(`clicked:${tab}`, function() {
            console.log("  clicked " + tab);
            setAttrs({ actiontab: tab });
        });
    });

    const moveTabs = ["walk", "sprint", "climb", "swim", "jump"];
    moveTabs.forEach(tab => {
        on(`clicked:${tab}`, function() {
            let val = String(tab).charAt(0).toUpperCase() + String(tab).slice(1);
            let t = tab; if(tab == "walk") t = "";
    		var attrsToChange = {};
            getAttrs([t+"speed", "move"], function(v) {
                console.log("  clicked " + tab + "; retrieving " + t+"speed (" + v[t+"speed"] + ")");
                attrsToChange["move"] = v[t+"speed"];
                attrsToChange["movement"] = val;
        		setAttrs(attrsToChange);
            });
        });
    });


/*===== auto-computing fields =====*/
    const abilities = ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"];
    abilities.forEach(ability => { on(`change:${ability}`, function() { updatemod(ability); }); });
 
    const saves = ["athletics", "reflex", "fortitude", "deduction", "perception","willpower"];
    saves.forEach(save => { on(`change:${save}`, function() { updatedv(save); }); });

    const skills = ["athletics", 
                    "reflex", "stealth", "finesse",
                    "fortitude", 
                    "deduction", "arcana", "crafting", "lore",
                    "perception", "animal-ken", "nature", "medicine",
                    "willpower", "charm", "wit"];
    skills.forEach(skill => { on(`clicked:train-${skill}`, function() { train(skill); }); });

    on("change:character_name", function(eventInfo) { setupActions(); });
    on("change:race", function(eventInfo) { setupRace(); });
    on("change:class", function(eventInfo) { setupClass(); });
    on("change:level", function(eventInfo) { validate(); });
    
    on("sheet:opened", function() {
      initialize();    
      validate();
      abilities.forEach(ability => { updatemod(ability); });
      saves.forEach(save => { updatedv(save); });
      setupActions();
    });
 
    var raceTable = [];
    var raceTable2 = [];
    var raceData = {};
    var classData = {};
    function initialize() {
        console.log("---=== initializing race and class data ===---");
        raceData["human"] = "none";
        raceData["dwarf"] = "Con, Str";
        raceData["elf"] = "Dex, Wis";
        raceData["halfling"] = "Dex, Cha";
        raceData["hen-ge"] = "none";
        raceData["goblin"] = "Dex, Con";
        raceData["lizardfolk"] = "Dex, Str";
        raceData["centaur"] = "Str, Wis";
        raceData["satyr"] = "Cha, Wis";
        raceData["genasi"] = "Con, Wis";

        raceTable[1] = "human";
        raceTable[2] = "human";
        raceTable[3] = "human";
        raceTable[4] = "human";
        raceTable[5] = "human";
        raceTable[6] = "human";
        raceTable[7] = "human";
        raceTable[8] = "human";
        raceTable[9] = "human";
        raceTable[10] = "human";
        raceTable[11] = "dwarf";
        raceTable[12] = "dwarf";
        raceTable[13] = "dwarf";
        raceTable[14] = "dwarf";
        raceTable[15] = "elf";
        raceTable[16] = "elf";
        raceTable[17] = "elf";
        raceTable[18] = "halfling";
        raceTable[19] = "halfling";
        raceTable[20] = "*";
        
        raceTable2[1] = "goblin";
        raceTable2[2] = "goblin";
        raceTable2[3] = "goblin";
        raceTable2[4] = "goblin";
        raceTable2[5] = "goblin";
        raceTable2[6] = "lizardfolk";
        raceTable2[7] = "lizardfolk";
        raceTable2[8] = "lizardfolk";
        raceTable2[9] = "genasi";
        raceTable2[10] = "genasi";
        raceTable2[11] = "genasi";
        raceTable2[12] = "hen-ge";
        raceTable2[13] = "hen-ge";
        raceTable2[14] = "hen-ge";
        raceTable2[15] = "satyr";
        raceTable2[16] = "satyr";
        raceTable2[17] = "satyr";
        raceTable2[18] = "centaur";
        raceTable2[19] = "centaur";
        raceTable2[20] = "centaur";
        
        
        var loadClass = {};
        loadClass["class_max"] = "knight";
        loadClass["hd1"] = "d10";
        loadClass["hd2"] = "d10";
        loadClass["hd3"] = "d10";
        loadClass["hd4"] = "d10";
        loadClass["l1feat"] = "warrior-1, knight-1";
        loadClass["l2feat"] = "warrior-2";
        loadClass["l3feat"] = "knight-3";
        loadClass["l4feat"] = "warrior-4";
        loadClass["l5feat"] = "warrior-5";
        loadClass["l6feat"] = "knight-6";
        loadClass["l7feat"] = "warrior-7";
        loadClass["l8feat"] = "warrior-8";
        loadClass["l9feat"] = "warrior-9";
        loadClass["l10feat"] = "warrior-10";
        loadClass["l1feat_max"] = "athletics, fortitude, animal-ken";
        loadClass["l2feat_max"] = "athletics, fortitude, reflex";
        loadClass["l3feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l4feat_max"] = "choose(any)";
        loadClass["l5feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l6feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l7feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l8feat_max"] = "choose(any)";
        loadClass["l9feat_max"] = "choose(athletics, fortitude, reflex, animal-ken, perception, willpower)";
        loadClass["l10feat_max"] = "choose(any)";
        classData["knight"] = JSON.parse(JSON.stringify(loadClass));

        loadClass["class_max"] = "martial-artist";
        loadClass["l1feat"] = "warrior-1, martial-artist-1";
        loadClass["l3feat"] = "martial-artist-3";
        loadClass["l6feat"] = "martial-artist-6";
        loadClass["l1feat_max"] = "athletics, reflex, perception";
        classData["martial-artist"] = JSON.parse(JSON.stringify(loadClass));
        
        loadClass["class_max"] = "berserker";
        loadClass["l1feat"] = "warrior-1, berserker-1";
        loadClass["l3feat"] = "berserker-3";
        loadClass["l6feat"] = "berserker-6";
        loadClass["l1feat_max"] = "athletics, reflex, fortitude";
        classData["berserker"] = JSON.parse(JSON.stringify(loadClass));
        
        loadClass["class_max"] = "thief";
        loadClass["hd1"] = "d8";
        loadClass["hd2"] = "d8";
        loadClass["hd3"] = "d8";
        loadClass["hd4"] = "d8";
        loadClass["l1feat"] = "expert-1, thief-1";
        loadClass["l2feat"] = "thief-2";
        loadClass["l3feat"] = "expert-3";
        loadClass["l4feat"] = "expert-4";
        loadClass["l5feat"] = "thief-5";
        loadClass["l6feat"] = "thief-6";
        loadClass["l7feat"] = "thief-7";
        loadClass["l8feat"] = "expert-8";
        loadClass["l9feat"] = "thief-9";
        loadClass["l10feat"] = "thief-10";
        loadClass["l1feat_max"] = "reflex, stealth, finesse, perception, choose(reflex, stealth, finesse, perception)";
        loadClass["l2feat_max"] = "choose(any), choose(any)";
        loadClass["l3feat_max"] = "choose(any), choose(any)";
        loadClass["l4feat_max"] = "choose(any), choose(any)";
        loadClass["l5feat_max"] = "choose(any), choose(any)";
        loadClass["l6feat_max"] = "choose(any), choose(any)";
        loadClass["l7feat_max"] = "choose(any), choose(any)";
        loadClass["l8feat_max"] = "choose(any), choose(any)";
        loadClass["l9feat_max"] = "choose(any), choose(any)";
        loadClass["l10feat_max"] = "choose(any), choose(any)";
        classData["thief"] = JSON.parse(JSON.stringify(loadClass));

        loadClass["class_max"] = "alchemist";
        loadClass["l1feat"] = "expert-1, alchemist-1";
        loadClass["l2feat"] = "alchemist-2";
        loadClass["l5feat"] = "alchemist-5";
        loadClass["l6feat"] = "alchemist-6";
        loadClass["l7feat"] = "alchemist-7";
        loadClass["l9feat"] = "alchemist-9";
        loadClass["l10feat"] = "alchemist-10";
        loadClass["l1feat_max"] = "arcana, crafting, finesse, medicine, choose(arcana, crafting, finesse, medicine)";
        classData["alchemist"] = JSON.parse(JSON.stringify(loadClass));

        loadClass["class_max"] = "bard";
        loadClass["l1feat"] = "expert-1, bard-1";
        loadClass["l2feat"] = "bard-2";
        loadClass["l5feat"] = "bard-5";
        loadClass["l6feat"] = "bard-6";
        loadClass["l7feat"] = "bard-7";
        loadClass["l9feat"] = "bard-9";
        loadClass["l10feat"] = "bard-10";
        loadClass["l1feat_max"] = "charm, wit, finesse, lore, choose(charm, wit, finesse, lore)";
        classData["bard"] = JSON.parse(JSON.stringify(loadClass));

        loadClass["class_max"] = "druid";
        loadClass["l1feat"] = "druid-1";
        loadClass["l2feat"] = "druid-2";
        loadClass["l3feat"] = "druid-3";
        loadClass["l4feat"] = "druid-4";
        loadClass["l5feat"] = "druid-5";
        loadClass["l6feat"] = "druid-6";
        loadClass["l7feat"] = "druid-7";
        loadClass["l8feat"] = "druid-8";
        loadClass["l9feat"] = "druid-9";
        loadClass["l10feat"] = "druid-10";
        loadClass["l1feat_max"] = "nature, animal-ken";
        loadClass["l2feat_max"] = "choose(crafting, fortitude, lore, medicine, perception)";
        loadClass["l3feat_max"] = "choose(nature, animal-ken)";
        loadClass["l4feat_max"] = "choose(any)";
        loadClass["l5feat_max"] = "choose(nature, animal-ken)";
        loadClass["l6feat_max"] = "choose(nature, animal-ken, crafting, fortitude, lore, medicine, perception)";
        loadClass["l7feat_max"] = "choose(nature, animal-ken)";
        loadClass["l8feat_max"] = "choose(any)";
        loadClass["l9feat_max"] = "choose(nature, animal-ken)";
        loadClass["l10feat_max"] = "choose(nature, animal-ken, crafting, fortitude, lore, medicine, perception)";
        classData["druid"] = JSON.parse(JSON.stringify(loadClass));
        
        loadClass["class_max"] = "wizard";
        loadClass["hd1"] = "d6";
        loadClass["hd2"] = "d6";
        loadClass["hd3"] = "d6";
        loadClass["hd4"] = "d6";
        loadClass["l1feat"] = "wizard-1";
        loadClass["l2feat"] = "wizard-2";
        loadClass["l3feat"] = "wizard-3";
        loadClass["l4feat"] = "wizard-4";
        loadClass["l5feat"] = "wizard-5";
        loadClass["l6feat"] = "wizard-6";
        loadClass["l7feat"] = "wizard-7";
        loadClass["l8feat"] = "wizard-8";
        loadClass["l9feat"] = "wizard-9";
        loadClass["l10feat"] = "wizard-10";
        loadClass["l1feat_max"] = "arcana, deduction";
        loadClass["l2feat_max"] = "choose(crafting, lore, medicine, perception)";
        loadClass["l3feat_max"] = "arcana";
        loadClass["l4feat_max"] = "choose(any)";
        loadClass["l5feat_max"] = "arcana";
        loadClass["l6feat_max"] = "choose(deduction, crafting, lore, medicine, perception)";
        loadClass["l7feat_max"] = "arcana";
        loadClass["l8feat_max"] = "choose(any)";
        loadClass["l9feat_max"] = "arcana";
        loadClass["l10feat_max"] = "choose(deduction, crafting, lore, medicine, perception)";
        classData["wizard"] = JSON.parse(JSON.stringify(loadClass));


        loadClass["class_max"] = "cleric";
        loadClass["l1feat"] = "cleric-1";
        loadClass["l2feat"] = "cleric-2";
        loadClass["l3feat"] = "cleric-3";
        loadClass["l4feat"] = "cleric-4";
        loadClass["l5feat"] = "cleric-5";
        loadClass["l6feat"] = "cleric-6";
        loadClass["l7feat"] = "cleric-7";
        loadClass["l8feat"] = "cleric-8";
        loadClass["l9feat"] = "cleric-9";
        loadClass["l10feat"] = "cleric-10";
        loadClass["l1feat_max"] = "willpower, perception";
        loadClass["l2feat_max"] = "choose(charm, fortitude, lore, medicine)";
        loadClass["l3feat_max"] = "willpower";
        loadClass["l4feat_max"] = "choose(any)";
        loadClass["l5feat_max"] = "willpower";
        loadClass["l6feat_max"] = "choose(perception, charm, fortitude, lore, medicine)";
        loadClass["l7feat_max"] = "willpower";
        loadClass["l8feat_max"] = "choose(any)";
        loadClass["l9feat_max"] = "willpower";
        loadClass["l10feat_max"] = "choose(perception, charm, fortitude, lore, medicine)";
        classData["cleric"] = JSON.parse(JSON.stringify(loadClass));
        
        
        getAttrs(levelUpData, function(values) {
            if(values["l1feat"]==undefined) {
                console.log("---=== NEW CHARACTER DETECTED ===---");
                if(values["class"]==undefined) {
                    console.log("---=== NO CLASS CHOSEN ===---");
                } else {
                    setAttrs(classData[values["class"]]);
                }
            }
        });
    }
    
    function setupRace() {
        getAttrs(["race"], function(values) {
            setAttrs({ "race_max": raceData[values["race"]] });
        });
        validate();
    }
    
    function setupClass() {
        getAttrs(["class", "class_max", "level"], function(values) {
            let level = values["level"];
            if(level == undefined || level == 0) {
                newClass = values["class"];
                console.log("WARNING! Changing class to " + newClass);
                setAttrs(classData[newClass]);
            } else if(values["class"] != values["class_max"]) { 
                // undo the change
                console.log("WARNING! Changing class back to " + values["class_max"]);
                //setAttrs({ "class": values["class_max"] });
            }
        });
        validate();
    }
    
    const levelUpData = ["class", "level", 
                        "l1feat", "l2feat", "l3feat", "l4feat", "l5feat", "l6feat", "l7feat", "l8feat", "l9feat", "l10feat",
                        "l1feat_max", "l2feat_max", "l3feat_max", "l4feat_max", "l5feat_max", "l6feat_max", "l7feat_max", "l8feat_max", "l9feat_max", "l10feat_max" ];
    function validate() {
        getAttrs(["character_name"], function(values) {
            console.log("---=== validating " + values["character_name"] + " ===---");
        });
        getAttrs(levelUpData, function(values) {
            if(values["l1feat"] == undefined) {
                console.log("UNINITIALIZED CHARACTER! Aborting validation.");
                return;
            }
            let level = values["level"];
            let powerMax = Math.floor(level/3+.667);
            console.log("level " + level + " " + values["class"] + " (" + powerMax + "hd)");

            let power = "";
            let feats = values["l1feat"];
            let skillList = values["l1feat_max"];
            let skillOptions = "";
            if(skillList.includes("choose(")) {
                let splitArray = skillList.split("choose(");
                skillList = splitArray[0];
                for(let i=1; i<splitArray.length; i++) skillOptions += "choose(" + splitArray[i];
            }
            for(let i=2; i<=level;i++) {
                let feat = values["l"+i+"feat"];
                let skill = values["l"+i+"feat_max"];
                console.log(feat);
                feats += ", " + feat;
                if(power == "" && feat.includes("-3")) power = feat;
                if(skill.includes("choose(")) {
                    let splitArray = skill.split("choose(");
                    if(splitArray[0] > "") skillList += ", " + splitArray[0];
                    for(let i=1; i<splitArray.length; i++) {
                        if(skillOptions > "") skillOptions += ", ";
                        skillOptions += "choose(" + splitArray[i];
                    }
                } else { skillList += ", " + skill; }
            }
            console.log(feats);
            console.log(skillList);
            console.log(skillOptions);

            if(power == "") powerMax = 0;
            
            let attacks = 1;
            if(feats.includes("warrior-9")) attacks =3;
            else if(feats.includes("warrior-5")) attacks =2;
            
            var attackDie; // set Attack Die from best class and level
            if(feats.includes("warrior-10")) { 
                attackDie = "d12";
            } else if(feats.includes("warrior-7")) { 
                attackDie = "d10";
            } else if(feats.includes("warrior-4")
                    || feats.includes("expert-9") 
                    || feats.includes("thief-9") 
                    || feats.includes("bard-9") 
                    || feats.includes("alchemist-9")) { 
                attackDie = "d8";
            } else if(feats.includes("warrior-1") 
                    || feats.includes("expert-5") 
                    || feats.includes("thief-5") 
                    || feats.includes("bard-5") 
                    || feats.includes("alchemist-5")) { 
                attackDie = "d6";
            } else if(feats.includes("expert-1")) {
                attackDie = "d4"; 
            } else {
                attackDie = "";
            }
            setAttrs({ featlist: feats, powername: power, power_max: powerMax, attack: attackDie, attack_max: attacks });
           
            var skillData = {};
            skills.forEach(skill => { skillData[skill] = "2d4kl1"; skillData[skill+"_max"] = "d4"; });
            
            if(feats.includes("warrior-2")) { // Superior Athlete
                skillData["athletics_max"]  = biggerDie(skillData["athletics_max"], attackDie);
                skillData["reflex_max"]     = biggerDie(skillData["reflex_max"], attackDie);
                skillData["fortitude_max"]  = biggerDie(skillData["fortitude_max"], attackDie);
            }
            
            var maxDie;
            if(feats.includes("expert-10")
            || feats.includes("wizard-9")
            || feats.includes("cleric-9")
            || feats.includes("druid-9")) { 
                maxDie = "d12";
            } else if(feats.includes("expert-7")
            || feats.includes("wizard-7")
            || feats.includes("cleric-7")
            || feats.includes("druid-7")) { 
                maxDie = "d10";
            } else if(feats.includes("expert-4")
            || feats.includes("wizard-5")
            || feats.includes("cleric-5")
            || feats.includes("druid-5") 
            || feats.includes("warrior-9")) {
                maxDie = "d8";
            } else if(feats.includes("expert-1") 
            || feats.includes("wizard-3") 
            || feats.includes("cleric-3") 
            || feats.includes("druid-3") 
            || feats.includes("warrior-5")) { 
                maxDie = "d6";                
            } else {
                maxDie = "d4";
            }
            console.log("  attack -> " + attackDie);
            
            skills.forEach(skill => { 
                skillData[skill+"_max"] = biggerDie(skillData[skill+"_max"], maxDie);
                let skillLevel = countMatches(skillList, skill);
                if(skillLevel > 0) {
                    if(skillLevel > 5) skillLevel = 5;
                    skillData[skill] = "d" + (skillLevel+1)*2;
                    if(biggerDie(skillData[skill], skillData[skill+"_max"]) == skillData[skill]) {
                      skillData[skill] = skillData[skill+"_max"];
                    }
                }
                let opt = "";
                if((skillOptions.includes(skill) || skillOptions.includes("any")) 
                && biggerDie(skillData[skill], skillData[skill+"_max"]) != skillData[skill]) {
                    opt = " - *can train";
                    $20(`button[name=act_train-${skill}]`).removeClass('hidden');
                } else { 
                    $20(`button[name=act_train-${skill}]`).addClass('hidden'); 
                }
                console.log("  " + skill + " -> " + skillData[skill] + " (max " + skillData[skill+"_max"] + ")" + opt);
            });
            setAttrs(skillData);
        });
    }
    
    function updatedv(save) {
      let dv = save+"-dv"; 
      let mod = save2mod(save);
      if(mod == "") {
          console.log("ERROR: " + save + " isn't a saving throw skill.");
          return;
      }
      console.log("updating " + save + "("+mod+")");
      getAttrs([save, mod], function(values) {
        if(values[save] == undefined || values[mod] == undefined) {
            console.log("--Uninitialized! Aborting...");
        }
        
        let prof = values[save];
        let val = 10+1*values[mod];
        val += die2dv(prof);
        console.log("  " + save + " (" + prof + values[mod] + ") => " + dv + " (" + val + ")");
    	setAttrs({ [dv]: val });      
      });
    }

 function updatemod(ability) {
  console.log("updating " + ability ); 
  getAttrs([ability,"race_max"], function(values) {
    let raceMods = values["race_max"];
    let score = values[ability];
    if(score == undefined) {
      score = rollAbility(ability);
      console.log("rolling " + ability + " (3d6): " + score);
      setAttrs({ [ability]: score });
    }
    let modname = ability.substring(0,3);
    let mod = a2mod(score);
    if(String(raceMods).toLowerCase().includes(String(modname).toLowerCase())) {
      mod++;
      if(mod >= 0) mod = "+" + mod; 
    }
    console.log("  " + ability + " (" + score + ") => " + modname + " (" + mod + ")");
    setAttrs({ [modname]: mod });
    updatedv(mod2save(modname));
  });
 }

 function train(skill) {
    getAttrs([skill,skill+"_max"], function(values) {
      let die = values[skill];
      let max = values[skill+"_max"];
      console.log("  " + skill + ": " + die + " (max "+max + ")");
      let dv = die2dv(die);
      if(dv == 0) {
        die = "d4";
      } else if(dv < die2dv(max)) {
        dv++;
        die = "d"+dv*2;
      }
      if(die != values[skill]) {
        console.log("  " + skill + " => " + die + " (max "+max + ")");
        setAttrs({ [skill]: die });
        getAttrs(levelUpData, function(values) {
          for(let level = 1; level <= values["level"]; level++) {
            let choices = values["l"+level+"feat_max"];
            if( choices.includes("choose(")
            && (choices.includes("any") || choices.includes(skill)) ) {
              let splitArray = choices.split("choose(");
              let skillList = splitArray[0];
              for(let i = 1; i < splitArray.length; i++) {
                if(skillList > "") skillList += ", ";
                if( splitArray[i].includes("any") || splitArray[i].includes(skill) ) { 
                  skillList += skill;
                  for(i++; i < splitArray.length; i++) { // only replace the first one
                    skillList += "choose(" + splitArray[i];  
                  }
                } else { 
                  skillList += "choose(" + splitArray[i]; 
                }
              }
              console.log("   (replaces level " + level + " choice: ["+values["l"+level+"feat_max"]+"] -> ["+skillList+"])");
              setAttrs({ ["l"+level+"feat_max"]: skillList });
              validate();
            }
          }
        });
      }
    });
 }
 
 function setupActions() {
    getAttrs(["character_name", "attack1_action", "attack2_action"], function(v) {
		var attrsToChange = {};
		attrsToChange["attack1_action"] = "%{" + v["character_name"] + "|attack1}";
		attrsToChange["attack2_action"] = "%{" + v["character_name"] + "|attack2}";
		setAttrs(attrsToChange);
	});
 }


 function rollD6() {
   return Math.floor(Math.random()*6+1);
 }
 
 function rollAbility(ability) {
   return rollD6()+rollD6()+rollD6();
 }
 
 function biggerDie(a, b) {
    if(die2dv(a) >= die2dv(b)) return a;
    return b;
 }
 
 function die2dv(d) {
    if(d[0] != "d") return 0;
    return Math.floor(d.substring(1,3)*0.5);
 }
 
 function a2mod(a) {
  if(a==3) return "-3";
  if(a<6) return "-2";
  if(a<9) return "-1";
  if(a==18) return "+3";
  if(a>15) return "+2";
  if(a>12) return "+1";
  return "+0";
 }
 
 function save2mod(save) {
    if(save == "athletics") return "str";
    if(save == "reflex") return "dex";
    if(save == "fortitude") return "con";
    if(save == "deduction") return "int";
    if(save == "perception") return "wis";
    if(save == "willpower") return "cha";
    return "";
 }
 function mod2save(mod) {
    if(mod == "str") return "athletics";
    if(mod == "dex") return "reflex";
    if(mod == "con") return "fortitude";
    if(mod == "int") return "deduction";
    if(mod == "wis") return "perception";
    if(mod == "cha") return "willpower";
    return "";
 }
 
 function countMatches(str, test) {
    let regex = new RegExp(test, "g"); 
    return (str.match(regex ) || []).length;
 }
    

</script>
